# 多语言维度生成与解析配置（tarot-ai-generator）

本文档用于指导 **tarot-ai-generator** 工具在离线环境下完成多语言维度推荐与翻译数据的生成。目标是在输入中文或其它基础语言问题后，自动完成多语种翻译、维度分析、结果合并，并输出用于 `dimension` 与 `dimension_translation` 表的数据草稿。

---

## 1. 能力范围与目标
- 读取 `config/settings.yaml` 与 `config/multilingual_dimension.yaml` 获取全局及多语言策略配置。
- 接收命令行传入的用户问题（默认中文），按配置顺序翻译到多个语言。
- 为每种语言生成三张牌阵（或其它配置牌阵）的维度建议与概述，并解析成结构化 JSON。
- 使用根语言（`root_dimension_locale`）作为 `dimension` 表写入依据，其他语言生成 `dimension_translation` 数据。
- 输出统一 JSON 文件，供后续人工审核或脚本导入数据库。

---

## 2. 数据流概览
1. **输入问题**  
   CLI 参数 `--multilingual-question "我下个月的运势如何？"`。
2. **配置读取**  
   - `settings.yaml`：全局模型、路径、速率限制等。
   - `multilingual_dimension.yaml`：多语言翻译、分析提示词、模型选择等。
3. **翻译阶段**  
   - 仅对 pipeline 中的目标语言执行翻译。
   - 每个语言可指定专用模型与提示词模板。
4. **分析阶段**  
   - 根语言与各目标语言分别调用分析提示词（强制 JSON 输出）。
   - 解析为统一结构 `{"locale": "...", "dimensions": [...], "overall_summary": "..."}`。
5. **结果合并**  
   - 按 index 将根语言维度与其它语种维度对齐。
   - 生成 `dimension_key + localizations` 输出。
6. **保存输出**  
   - 默认保存到 `./output/multilingual_dimensions.json`，可通过 `--multilingual-output` 自定义路径。

---

## 3. 配置文件说明

### 3.1 `config/settings.yaml`
```yaml
general:
  output_path: "./output/card_interpretation_dimensions.json"
  multilingual_output_path: "./output/multilingual_dimensions.json"

paths:
  card_interpretations: "data/config_jsons/card_interpretations.json"
  dimensions: "data/config_jsons/dimensions.json"
  prompt_template: "prompt_template.txt"

llm:
  default_provider: "openai"
  default_model: "gpt-3.5-turbo"
  temperature: 0.1
  max_tokens: 1000
  rate_limit_per_minute: 60
  batch_size: 10
  openai:
    base_url: "https://api.hdgsb.com/v1"
    model: "gpt-3.5-turbo"
  zhipu:
    model: "glm-4-Flash"
  ollama:
    base_url: "http://localhost:11434"
    model: "dolphin3:8b"
```

- `config/settings.yaml` 维护默认模型参数与 `llm.<provider>.api_key`。
- `.env` 可选覆盖个别字段（默认留空）。
- 所有非敏感、结构化配置写入 YAML，代码中不再硬编码默认值。

### 3.2 `config/multilingual_dimension.yaml`
```yaml
source_locale: zh-CN
root_dimension_locale: zh-CN
default_spread: three-card

source_analysis:
  provider: zhipu
  model: glm-4-Flash
  temperature: 0.2
  prompt_template: prompts/analyze_three_card.zh.txt

translation_pipeline:
  - locale: en-US
    language_name: English
    translation:
      provider: openai
      model: gpt-4o-mini
      temperature: 0.2
      prompt_template: prompts/translate_to_en.txt
    analysis:
      provider: openai
      model: gpt-4o-mini
      temperature: 0.2
      prompt_template: prompts/analyze_three_card.en.txt
  - locale: ja-JP
    language_name: Japanese
    translation:
      provider: openai
      model: gpt-4o-mini
      temperature: 0.2
      prompt_template: prompts/translate_to_ja.txt
    analysis:
      provider: openai
      model: gpt-4o-mini
      temperature: 0.2
      prompt_template: prompts/analyze_three_card.ja.txt

guardrails:
  force_json: true
  retry: 2
  timeout_seconds: 40
```

#### 关键字段说明
- `source_locale`：输入问题的语言标签。
- `root_dimension_locale`：用于 `dimension` 主表的语言。
- `source_analysis`：根语言的模型与提示词定义。
- `translation_pipeline`：按顺序执行的目标语言。每个 entry 提供：
  - `translation`：翻译阶段的模型与提示词。
  - `analysis`：维度分析阶段的模型与提示词。
- `guardrails.force_json`：当 `provider=openai` 时自动开启 JSON 输出模式；其它模型通过提示词约束。

---

## 4. 输出格式
生成的 `multilingual_dimensions.json` 结构如下：

```json
{
  "version": "1.0.0",
  "generated_at": "2025-10-15T10:40:00Z",
  "source_question": "我下个月的运势如何？",
  "spread_type": "three-card",
  "source_locale": "zh-CN",
  "root_dimension_locale": "zh-CN",
  "guardrails": {"force_json": true, "retry": 2, "timeout_seconds": 40},
  "dimensions": [
    {
      "dimension_key": {
        "category": "整体",
        "aspect": "过去",
        "aspect_type": 1
      },
      "localizations": [
        {
          "locale": "zh-CN",
          "name": "整体-过去",
          "category": "整体",
          "aspect": "过去",
          "aspect_type": 1,
          "description": "……",
          "summary": "……"
        },
        {
          "locale": "en-US",
          "name": "General-Past",
          "category": "General",
          "aspect": "Past",
          "aspect_type": 1,
          "description": "……",
          "summary": "……"
        }
      ]
    }
  ],
  "locales": [
    {
      "locale": "zh-CN",
      "question": "我下个月的运势如何？",
      "overall_summary": "……",
      "provider": "zhipu",
      "model": "glm-4-Flash",
      "prompt_template": "prompts/analyze_three_card.zh.txt"
    },
    {
      "locale": "en-US",
      "question": "What will my fortune be like next month?",
      "overall_summary": "……",
      "provider": "openai",
      "model": "gpt-4o-mini",
      "prompt_template": "prompts/analyze_three_card.en.txt",
      "translation": {
        "provider": "openai",
        "model": "gpt-4o-mini",
        "prompt_template": "prompts/translate_to_en.txt"
      }
    }
  ]
}
```

`dimensions[*].dimension_key` 可用于 `dimension` 表去重，`localizations` 列表可直接映射到 `dimension_translation` 的多语言数据。

---

## 5. CLI 使用方式
```bash
# 生成多语言维度与翻译结果（默认 three-card）
python main.py --multilingual-question "我下个月的运势如何？"

# 指定牌阵类型 & 自定义输出
python main.py \
  --multilingual-question "我需要换工作吗？" \
  --spread-type three-card \
  --multilingual-output ./output/my_question_multilingual.json
```

运行后，工具将：
1. 输出翻译与分析进度日志；
2. 将结果保存到指定 JSON；
3. 提示输出文件路径，供后续导入数据库或人工校对。

---

## 6. 提示词模板
- 所有多语言相关提示词位于 `prompts/` 目录：
  - `translate_to_*.txt`：翻译提示词
  - `analyze_three_card.*.txt`：三牌阵维度分析提示词
- 如需支持新语言，只需：
  1. 新增翻译和分析提示词文件；
  2. 在 `multilingual_dimension.yaml` 中添加对应配置项。

---

## 7. 开发提示
- 翻译与分析可使用不同模型，以控制成本和质量。
- 若模型未返回合法 JSON，工具会根据 `guardrails.retry` 重试，最终仍失败时抛出异常。
- 生成的 JSON 建议先人工审阅，确认维度与翻译对齐后，再写入数据库。
- 可根据需要在 `.env` 设置 `OPENAI_BASE_URL`、`OLLAMA_BASE_URL` 等临时覆盖。默认使用 YAML 中的配置。

---

如需扩展其它牌阵（如凯尔特十字），可在配置中新增模板与 spread 对应逻辑，并适配解析结构。
