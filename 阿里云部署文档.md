# 阿里云部署指南

本文档指导如何在阿里云 ECS 实例上部署塔罗牌全栈应用（FastAPI 后端、Next.js 管理后台、Nginx 入口）。整体部署通过 Docker Compose 完成。

---

## 1. 部署前准备
- **实例规格**：建议至少 2 vCPU / 4 GB RAM，系统盘 ≥ 40 GB。操作系统推荐 Ubuntu 22.04 LTS。
- **域名与证书**：若需公网访问与 HTTPS，请准备绑定到实例公网 IP 的域名，并在阿里云证书服务或 Let’s Encrypt 申请证书。
- **安全组**：开放 22（SSH）、80（HTTP）、443（HTTPS）；如需调试后端可临时开放 8000，但生产不建议。
- **运维账号**：为部署创建普通用户（例如 `deploy`），使用 SSH 密钥登陆，尽量禁用密码登录。

---

## 2. ECS 环境初始化
1. **更新系统**
   ```bash
   sudo apt update && sudo apt upgrade -y
   sudo apt install -y ca-certificates curl gnupg lsb-release
   sudo timedatectl set-timezone Asia/Shanghai
   ```
2. **安装 Docker & Compose 插件**
   ```bash
   curl -fsSL https://download.docker.com/linux/ubuntu/gpg | sudo gpg --dearmor -o /etc/apt/keyrings/docker.gpg
   echo \
     "deb [arch=$(dpkg --print-architecture) signed-by=/etc/apt/keyrings/docker.gpg] https://download.docker.com/linux/ubuntu \
     $(lsb_release -cs) stable" | sudo tee /etc/apt/sources.list.d/docker.list > /dev/null
   sudo apt update
   sudo apt install -y docker-ce docker-ce-cli containerd.io docker-buildx-plugin docker-compose-plugin
   sudo usermod -aG docker $USER  # 重新登录生效
   ```
3. **系统强化**
   - 开启 UFW 防火墙并允许必要端口：
     ```bash
     sudo ufw allow OpenSSH
     sudo ufw allow 80/tcp
     sudo ufw allow 443/tcp
     sudo ufw enable
     ```
   - 配置自动安全更新：`sudo apt install unattended-upgrades` 并启用。

---

## 3. 项目部署目录结构
建议在 `/srv/my-tarot` 下存放项目与数据，并设置权限：
```bash
sudo mkdir -p /srv/my-tarot
sudo chown $USER:$USER /srv/my-tarot
```

推荐的生产目录布局：
```
/srv/my-tarot/
├── app/                 # Git 仓库
├── env/                 # 环境变量文件（gitignore）
├── data/                # SQLite 持久化目录
└── logs/                # Nginx / 应用日志
```

---

## 4. 获取代码与配置
1. **克隆仓库**
   ```bash
   cd /srv/my-tarot
   git clone https://<your_repo_url>.git app
   cd app
   ```
2. **准备生产环境变量**
   - 在 `/srv/my-tarot/env/backend.env` 中写入敏感信息：
     ```
     DATABASE_URL=sqlite:////data/backend_tarot.db
     API_PROVIDER=zhipu
     ZHIPUAI_API_KEY=<生产钥匙>
     OPENAI_API_KEY=<生产钥匙>
     OPENAI_BASE_URL=https://api.openai.com/v1
     MODEL_NAME=glm-4-Flash
     TEMPERATURE=0.7
     MAX_TOKENS=1000
     JWT_SECRET_KEY=<全新随机字符串>
     ADMIN_USERNAME=admin
     ADMIN_PASSWORD=<强密码>
     EMAIL_SMTP_HOST=smtp.qq.com
     EMAIL_SMTP_PORT=587
     EMAIL_FROM_ADDRESS=<生产邮箱>
     EMAIL_PASSWORD=<授权码>
     ```
   - 将 `.env` 从仓库中移除或确认不会覆盖生产配置。
3. **持久化目录映射**
   - 在 `docker-compose.yml` 中将 `backend_data` 调整为绑定 `/srv/my-tarot/data`。
   - 将 Nginx 日志目录映射到 `/srv/my-tarot/logs/nginx`（需要修改 Compose 与 `nginx.conf`）。

---

## 5. Docker Compose 生产化建议
- 新建 `docker-compose.prod.yml`：
  ```yaml
  services:
    backend:
      build:
        context: ./tarot-backend
      env_file:
        - ../env/backend.env
      volumes:
        - ../data:/data
        - ./tarot-backend/static:/app/static:ro
      restart: unless-stopped
      healthcheck:
        test: ["CMD-SHELL", "curl -fsS http://localhost:8000/health || exit 1"]
        interval: 30s
        timeout: 5s
        retries: 5

    admin:
      build:
        context: ./tarot-admin-web
      environment:
        NEXT_PUBLIC_BACKEND_URL: "/"
      depends_on:
        backend:
          condition: service_healthy
      restart: unless-stopped

    nginx:
      image: nginx:alpine
      depends_on:
        backend:
          condition: service_healthy
        admin:
          condition: service_started
      ports:
        - "80:80"
        - "443:443"
      volumes:
        - ./deploy/nginx/nginx.conf:/etc/nginx/nginx.conf:ro
        - ../logs/nginx:/var/log/nginx
        - /etc/letsencrypt:/etc/letsencrypt:ro
      restart: unless-stopped
  ```
- 如需 TLS，将证书放在 `/etc/letsencrypt/live/<domain>/` 并在 `nginx.conf` 中配置 `listen 443 ssl`。
- 根据实际资源情况添加 `deploy.resources.limits` 或 `mem_limit`。

---

## 6. 部署流程
1. **构建并启动**
   ```bash
   cd /srv/my-tarot/app
   docker compose -f docker-compose.yml -f docker-compose.prod.yml build
   docker compose -f docker-compose.yml -f docker-compose.prod.yml up -d
   ```
2. **检查运行状态**
   ```bash
   docker compose ps
   docker compose logs backend -f
   docker compose logs admin -f
   docker compose logs nginx -f
   ```
3. **验证服务**
   - 浏览器访问 `http://<ECS 公网 IP>/` 查看管理后台。
   - 调用 `http://<ECS 公网 IP>/api/v1/users/register` 进行 API 连通性测试。
4. **设置自动启动**
   - Docker 服务默认随系统启动。如需确保 Compose 堆栈在重启后恢复，可使用 `docker compose up -d` 的 systemd 服务，或在 `/etc/rc.local` 中添加启动脚本。

---

## 7. 安全与运维
- **秘钥轮换**：定期更换 JWT、管理员密码和外部 API Key，使用阿里云 KMS 或自建 Vault 存储。
- **数据库备份**：每日计划任务：
  ```bash
  sqlite3 /srv/my-tarot/data/backend_tarot.db ".backup '/srv/my-tarot/data/backup-$(date +%F).db'"
  find /srv/my-tarot/data -name "backup-*.db" -mtime +7 -delete
  ```
- **日志收集**：将 Nginx 和应用日志引入阿里云日志服务或其他集中化方案。
- **监控告警**：
  - 使用阿里云云监控添加端口探测或自建 `healthcheck`。
  - 配合 Prometheus/Alertmanager 或第三方服务实时报警。
- **防火墙**：仅开放必要端口，生产环境关闭 8000 直连。

---

## 8. 常见问题排查
- **容器无法启动**：查看 `docker compose logs <service>`，若为端口占用确认 80/443 未被其他服务使用。
- **证书更新失败**：检查 `/etc/letsencrypt` 权限与续签计划任务，可使用 `certbot` 的 `--nginx` 模式自动更新。
- **数据库损坏**：使用最近的 `backup-*.db` 替换 `/srv/my-tarot/data/backend_tarot.db`，替换前执行 `sqlite3 backup-file 'PRAGMA integrity_check;'`。
- **高负载**：利用 `docker stats` 与 `htop` 分析瓶颈，必要时升级 ECS 规格或启用水平扩展（需要进一步改造）。

---

## 9. 部署自动化建议
- 使用 GitHub Actions/GitLab CI 构建镜像并推送至阿里云容器镜像服务（ACR），ECS 上仅负责拉取镜像与启动。
- 编写部署脚本：
  ```bash
  #!/bin/bash
  set -euo pipefail
  cd /srv/my-tarot/app
  git pull --rebase
  docker compose -f docker-compose.yml -f docker-compose.prod.yml pull
  docker compose -f docker-compose.yml -f docker-compose.prod.yml up -d --remove-orphans
  docker image prune -f
  ```
- 结合 `cron` 或手动触发部署，确保有变更记录与回滚策略。

---

准备就绪后，可在阿里云控制台为实例配置监控与告警策略，并定期测试备份与容灾流程，保障塔罗牌应用稳定运行。
