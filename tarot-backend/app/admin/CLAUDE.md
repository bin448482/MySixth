# ç®¡ç†Portalè®¾è®¡ (app/admin/CLAUDE.md)

## ğŸ›ï¸ ç®¡ç†Portalæ¶æ„

### Portalç»„ç»‡ç»“æ„
```
app/admin/
â”œâ”€â”€ auth.py               # ç®¡ç†å‘˜è®¤è¯ (âœ… å·²å®ç°)
â”œâ”€â”€ web_routes.py         # ç®¡ç†é¡µé¢è·¯ç”± (âœ… å·²å®ç°)
â”œâ”€â”€ templates/            # HTMLæ¨¡æ¿ (âœ… å·²å®ç°)
â”‚   â”œâ”€â”€ base.html        # åŸºç¡€æ¨¡æ¿
â”‚   â”œâ”€â”€ login.html       # ç™»å½•é¡µé¢
â”‚   â”œâ”€â”€ dashboard.html   # ä»ªè¡¨æ¿
â”‚   â”œâ”€â”€ users.html       # ç”¨æˆ·ç®¡ç†
â”‚   â””â”€â”€ redeem_codes.html # å…‘æ¢ç ç®¡ç†
â””â”€â”€ static/              # é™æ€èµ„æº
    â”œâ”€â”€ css/admin.css    # ç®¡ç†æ ·å¼
    â””â”€â”€ js/admin.js      # ç®¡ç†è„šæœ¬
```

## ğŸ” è®¤è¯ç³»ç»Ÿ (âœ… å·²å®ç°)

**å®ç°ä½ç½®**: `app/admin/auth.py`

### æ ¸å¿ƒåŠŸèƒ½
- **AdminAuthService**: JWT tokenç®¡ç†ï¼Œå¯†ç éªŒè¯
- **ç®¡ç†å‘˜ä¾èµ–é¡¹**: Cookieè®¤è¯ï¼Œæƒé™éªŒè¯
- **ç¯å¢ƒé…ç½®**: ç”¨æˆ·åã€å¯†ç ã€è¿‡æœŸæ—¶é—´å¯é…ç½®

### å…³é”®æ–¹æ³•
```python
# ç™»å½•è®¤è¯
admin_auth_service.verify_credentials(username, password)

# TokenéªŒè¯
admin_auth_service.verify_admin_token(token)

# ä¾èµ–é¡¹éªŒè¯
get_current_admin_from_cookie(admin_token: str = Cookie(None))
```

## ğŸ  ç®¡ç†è·¯ç”± (âœ… å·²å®ç°)

**å®ç°ä½ç½®**: `app/admin/web_routes.py`

### æ ¸å¿ƒé¡µé¢è·¯ç”±
- **GET /admin/login**: ç™»å½•é¡µé¢ (`login.html`)
- **POST /admin/login**: ç™»å½•å¤„ç†ï¼Œè®¾ç½®Cookie
- **GET /admin/dashboard**: ä»ªè¡¨æ¿ (`dashboard.html`)
- **GET /admin/users**: ç”¨æˆ·ç®¡ç†é¡µé¢ (`users.html`)
- **GET /admin/redeem-codes**: å…‘æ¢ç ç®¡ç†é¡µé¢ (`redeem-codes.html`)

### è®¤è¯æœºåˆ¶
- Cookieè®¤è¯ï¼Œè‡ªåŠ¨é‡å®šå‘æœªç™»å½•ç”¨æˆ·
- å“åº”å¼æ¨¡æ¿è®¾è®¡ï¼Œæ”¯æŒå¤šå±å¹•é€‚é…

## ğŸ“Š APIæ¥å£ (âœ… å·²å®ç°)

**å®ç°ä½ç½®**: `app/api/admin.py`

### ç®¡ç†å‘˜è®¤è¯API
- **POST /api/v1/admin-api/login**: ç®¡ç†å‘˜ç™»å½•
- **GET /api/v1/admin-api/profile**: è·å–å½“å‰ç®¡ç†å‘˜ä¿¡æ¯
- **POST /api/v1/admin-api/refresh**: åˆ·æ–°JWT token

### ç”¨æˆ·ç®¡ç†API
- **GET /api/v1/admin/users**: ç”¨æˆ·åˆ—è¡¨æŸ¥è¯¢ï¼ˆåˆ†é¡µã€ç­›é€‰ï¼‰
- **GET /api/v1/admin/users/{id}**: ç”¨æˆ·è¯¦æƒ…
- **POST /api/v1/admin/users/adjust-credits**: ç§¯åˆ†è°ƒæ•´
- **GET /api/v1/admin/users/export**: ç”¨æˆ·æ•°æ®CSVå¯¼å‡º
- **DELETE /api/v1/admin/users/{id}**: åˆ é™¤ç”¨æˆ·

### å…‘æ¢ç ç®¡ç†API
- **GET /api/v1/admin/redeem-codes**: å…‘æ¢ç åˆ—è¡¨æŸ¥è¯¢
- **POST /api/v1/admin/redeem-codes/generate**: æ‰¹é‡ç”Ÿæˆå…‘æ¢ç 
- **PUT /api/v1/admin/redeem-codes/{id}**: æ›´æ–°å…‘æ¢ç çŠ¶æ€
- **GET /api/v1/admin/redeem-codes/export/csv**: å…‘æ¢ç CSVå¯¼å‡º
- **GET /api/v1/admin/redeem-codes/stats**: ç»Ÿè®¡ä¿¡æ¯

## ğŸ¨ å‰ç«¯æ¨¡æ¿ (âœ… å·²å®ç°)

**å®ç°ä½ç½®**: `app/admin/templates/`

### ç”¨æˆ·ç®¡ç†åŠŸèƒ½ (`users.html`)
1. **æœç´¢ç­›é€‰**: ç”¨æˆ·IDã€é‚®ç®±ã€ç§¯åˆ†ã€æ³¨å†Œæ—¶é—´ç­›é€‰
2. **åˆ—è¡¨å±•ç¤º**: åˆ†é¡µã€IDå¤åˆ¶ã€ç§¯åˆ†å¾½ç« ã€ç»Ÿè®¡ä¿¡æ¯
3. **ç”¨æˆ·æ“ä½œ**: æŸ¥çœ‹è¯¦æƒ…å¼¹çª—ã€ç§¯åˆ†è°ƒæ•´ã€åˆ é™¤ç”¨æˆ·
4. **æ•°æ®å¯¼å‡º**: æ”¯æŒç­›é€‰æ¡ä»¶çš„CSVå¯¼å‡º

### å…‘æ¢ç ç®¡ç†åŠŸèƒ½ (`redeem-codes.html`)
1. **åˆ—è¡¨æŸ¥è¯¢**: çŠ¶æ€ç­›é€‰ã€æ‰¹æ¬¡ç­›é€‰ã€ä»£ç æœç´¢
2. **æ‰¹é‡ç”Ÿæˆ**: è‡ªå®šä¹‰æ•°é‡ã€ç§¯åˆ†å€¼ã€æœ‰æ•ˆæœŸ
3. **çŠ¶æ€ç®¡ç†**: å¯ç”¨/ç¦ç”¨/è¿‡æœŸçŠ¶æ€åˆ‡æ¢
4. **ç»Ÿè®¡ä¿¡æ¯**: å®æ—¶æ˜¾ç¤ºå„çŠ¶æ€å…‘æ¢ç æ•°é‡

### å“åº”å¼è®¾è®¡
- Bootstrap 5æ¡†æ¶
- ç§»åŠ¨ç«¯é€‚é…
- åŠ è½½çŠ¶æ€å’Œé”™è¯¯å¤„ç†
- å®æ—¶æ•°æ®åˆ·æ–°

## ğŸ”§ æŠ€æœ¯ç‰¹æ€§

### è®¤è¯å®‰å…¨
- JWT token + Cookieå­˜å‚¨
- 24å°æ—¶è¿‡æœŸæ—¶é—´ï¼ˆå¯é…ç½®ï¼‰
- CSRFé˜²æŠ¤ï¼ˆç”Ÿäº§ç¯å¢ƒï¼‰
- æ“ä½œå®¡è®¡æ—¥å¿—

### æ•°æ®å¤„ç†
- åˆ†é¡µæŸ¥è¯¢ä¼˜åŒ–
- å…³è”æŸ¥è¯¢é¿å…N+1é—®é¢˜
- ä¹è§‚é”ä¿è¯æ•°æ®ä¸€è‡´æ€§
- æµå¼å“åº”æ”¯æŒå¤§æ–‡ä»¶å¯¼å‡º

### é”™è¯¯å¤„ç†
- å…¨å±€å¼‚å¸¸æ•è·
- ç”¨æˆ·å‹å¥½é”™è¯¯æç¤º
- è¯¦ç»†æ—¥å¿—è®°å½•
- è‡ªåŠ¨é”™è¯¯æ¢å¤

## ğŸ“‹ ä½¿ç”¨è¯´æ˜

### è®¿é—®ç®¡ç†åå°
1. è®¿é—® `http://localhost:8001/admin/login`
2. ä½¿ç”¨ç¯å¢ƒå˜é‡é…ç½®çš„ç®¡ç†å‘˜è´¦å·ç™»å½•
3. æˆåŠŸåé‡å®šå‘åˆ°ä»ªè¡¨æ¿

### ç”¨æˆ·ç®¡ç†æ“ä½œ
- **æŸ¥çœ‹ç”¨æˆ·**: `/admin/users` é¡µé¢æŸ¥çœ‹æ‰€æœ‰ç”¨æˆ·
- **ç”¨æˆ·è¯¦æƒ…**: ç‚¹å‡»"æŸ¥çœ‹è¯¦æƒ…"æŸ¥çœ‹å®Œæ•´ä¿¡æ¯å’Œäº¤æ˜“è®°å½•
- **è°ƒæ•´ç§¯åˆ†**: ä½¿ç”¨"è°ƒæ•´ç§¯åˆ†"åŠŸèƒ½å¢å‡ç”¨æˆ·ç§¯åˆ†
- **å¯¼å‡ºæ•°æ®**: ä½¿ç”¨ç­›é€‰æ¡ä»¶å¯¼å‡ºç”¨æˆ·æ•°æ®CSV

### å…‘æ¢ç ç®¡ç†æ“ä½œ
- **æŸ¥çœ‹å…‘æ¢ç **: `/admin/redeem-codes` é¡µé¢ç®¡ç†æ‰€æœ‰å…‘æ¢ç 
- **ç”Ÿæˆå…‘æ¢ç **: ä½¿ç”¨"ç”Ÿæˆå…‘æ¢ç "åŠŸèƒ½æ‰¹é‡åˆ›å»º
- **æ›´æ”¹çŠ¶æ€**: å¯ç”¨ã€ç¦ç”¨æˆ–è®¾ç½®è¿‡æœŸå…‘æ¢ç 
- **å¯¼å‡ºæ•°æ®**: å¯¼å‡ºå…‘æ¢ç ä½¿ç”¨æƒ…å†µCSV

## ğŸš€ å·²è§£å†³çš„æŠ€æœ¯é—®é¢˜

### è·¯ç”±å†²çªé—®é¢˜
- **é—®é¢˜**: `payments.py` å’Œ `admin.py` è·¯ç”±å†²çª
- **è§£å†³**: ç§»é™¤é‡å¤è·¯ç”±ï¼Œæ˜ç¡®æ¨¡å—èŒè´£è¾¹ç•Œ
- **å‚è€ƒ**: å‚è§ `tarot-backend/CLAUDE.md` è·¯ç”±å†²çªè§£å†³æ–¹æ¡ˆ

### é‚®ä»¶éªŒè¯404é”™è¯¯
- **é—®é¢˜**: é‚®ä»¶éªŒè¯é“¾æ¥è¿”å›404
- **è§£å†³**: ä¿®æ­£URLè·¯å¾„ç”Ÿæˆï¼Œç¡®ä¿ä¸å®é™…APIè·¯ç”±åŒ¹é…
- **å‚è€ƒ**: `app/services/email_service.py:31-32`

### ç”¨æˆ·åˆ é™¤çº¦æŸé”™è¯¯
- **é—®é¢˜**: åˆ é™¤ç”¨æˆ·æ—¶å¤–é”®çº¦æŸé”™è¯¯
- **è§£å†³**: æŒ‰æ­£ç¡®é¡ºåºåˆ é™¤å…³è”è¡¨æ•°æ®
- **å‚è€ƒ**: `app/api/admin.py:546-563`

---

*ç®¡ç†Portalå·²å®Œæ•´å®ç°ï¼Œæä¾›ç”¨æˆ·ç®¡ç†ã€å…‘æ¢ç ç®¡ç†ã€ç»Ÿè®¡æŠ¥è¡¨ç­‰å®Œæ•´åŠŸèƒ½ã€‚*