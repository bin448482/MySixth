{% extends "base.html" %}

{% block title %}订单管理 - 塔罗牌应用管理后台{% endblock %}
{% block page_title %}订单管理{% endblock %}

{% block page_actions %}
<button type="button" class="btn btn-outline-secondary" onclick="exportOrders()">
    <i class="fas fa-download me-2"></i>导出订单
</button>
<button type="button" class="btn btn-outline-info" onclick="refreshOrders()">
    <i class="fas fa-sync-alt me-2"></i>刷新数据
</button>
{% endblock %}

{% block content %}
<div class="row mb-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="fas fa-filter me-2"></i>筛选条件
                </h5>
            </div>
            <div class="card-body">
                <form id="filterForm" class="row g-3">
                    <div class="col-md-3">
                        <label for="orderIdFilter" class="form-label">订单号</label>
                        <input type="text" class="form-control" id="orderIdFilter"
                               placeholder="输入订单号">
                    </div>
                    <div class="col-md-2">
                        <label for="platformFilter" class="form-label">支付平台</label>
                        <select class="form-select" id="platformFilter">
                            <option value="">全部平台</option>
                            <option value="google_play">Google Play</option>
                            <option value="redeem_code">兑换码</option>
                            <option value="app_store">App Store</option>
                        </select>
                    </div>
                    <div class="col-md-2">
                        <label for="statusFilter" class="form-label">订单状态</label>
                        <select class="form-select" id="statusFilter">
                            <option value="">全部状态</option>
                            <option value="pending">待处理</option>
                            <option value="completed">已完成</option>
                            <option value="failed">失败</option>
                            <option value="refunded">已退款</option>
                        </select>
                    </div>
                    <div class="col-md-3">
                        <label for="dateRangeFilter" class="form-label">时间范围</label>
                        <select class="form-select" id="dateRangeFilter">
                            <option value="">全部时间</option>
                            <option value="today">今天</option>
                            <option value="week">本周</option>
                            <option value="month">本月</option>
                            <option value="quarter">本季度</option>
                        </select>
                    </div>
                    <div class="col-md-2">
                        <label class="form-label">&nbsp;</label>
                        <button type="button" class="btn btn-primary d-block w-100" onclick="searchOrders()">
                            <i class="fas fa-search"></i> 搜索
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- 统计卡片 -->
<div class="row mb-4">
    <div class="col-md-3">
        <div class="card stats-card border-start border-primary border-4">
            <div class="card-body">
                <div class="d-flex align-items-center">
                    <div class="flex-grow-1">
                        <div class="metric-value text-primary" id="totalOrders">0</div>
                        <div class="metric-label">总订单数</div>
                    </div>
                    <div class="text-primary">
                        <i class="fas fa-shopping-cart fa-2x"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card stats-card border-start border-success border-4">
            <div class="card-body">
                <div class="d-flex align-items-center">
                    <div class="flex-grow-1">
                        <div class="metric-value text-success" id="completedOrders">0</div>
                        <div class="metric-label">成功订单</div>
                    </div>
                    <div class="text-success">
                        <i class="fas fa-check-circle fa-2x"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card stats-card border-start border-info border-4">
            <div class="card-body">
                <div class="d-flex align-items-center">
                    <div class="flex-grow-1">
                        <div class="metric-value text-info" id="totalRevenue">¥0</div>
                        <div class="metric-label">总收入</div>
                    </div>
                    <div class="text-info">
                        <i class="fas fa-dollar-sign fa-2x"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card stats-card border-start border-warning border-4">
            <div class="card-body">
                <div class="d-flex align-items-center">
                    <div class="flex-grow-1">
                        <div class="metric-value text-warning" id="pendingOrders">0</div>
                        <div class="metric-label">待处理订单</div>
                    </div>
                    <div class="text-warning">
                        <i class="fas fa-clock fa-2x"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="row">
    <div class="col-12">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0">
                    <i class="fas fa-list me-2"></i>订单列表
                </h5>
                <span class="badge bg-secondary" id="orderCount">总计: 0 订单</span>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead class="table-light">
                            <tr>
                                <th>订单号</th>
                                <th>用户ID</th>
                                <th>平台</th>
                                <th>积分</th>
                                <th>金额</th>
                                <th>状态</th>
                                <th>创建时间</th>
                                <th>完成时间</th>
                                <th>操作</th>
                            </tr>
                        </thead>
                        <tbody id="ordersTableBody">
                            <tr>
                                <td colspan="9" class="text-center py-4">
                                    <div class="spinner-border" role="status">
                                        <span class="visually-hidden">加载中...</span>
                                    </div>
                                    <div class="mt-2">正在加载订单数据...</div>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>

                <!-- 分页 -->
                <nav aria-label="订单分页">
                    <ul class="pagination justify-content-center" id="pagination">
                        <li class="page-item disabled">
                            <span class="page-link">上一页</span>
                        </li>
                        <li class="page-item active">
                            <span class="page-link">1</span>
                        </li>
                        <li class="page-item disabled">
                            <span class="page-link">下一页</span>
                        </li>
                    </ul>
                </nav>
            </div>
        </div>
    </div>
</div>

<!-- 订单详情模态框 -->
<div class="modal fade" id="orderDetailModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-receipt me-2"></i>订单详情
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="orderDetailContent">
                <!-- 订单详情内容将在这里动态加载 -->
                <div class="text-center py-4">
                    <div class="spinner-border" role="status">
                        <span class="visually-hidden">加载中...</span>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">关闭</button>
                <button type="button" class="btn btn-warning" id="refundOrderBtn" style="display:none;">
                    <i class="fas fa-undo me-2"></i>申请退款
                </button>
            </div>
        </div>
    </div>
</div>

<!-- 退款确认模态框 -->
<div class="modal fade" id="refundModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title text-warning">
                    <i class="fas fa-exclamation-triangle me-2"></i>退款确认
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p>您确定要为此订单申请退款吗？</p>
                <div class="alert alert-warning">
                    <strong>注意：</strong> 退款操作不可撤销，用户的积分将被扣除。
                </div>
                <div class="mb-3">
                    <label for="refundReason" class="form-label">退款原因</label>
                    <textarea class="form-control" id="refundReason" rows="3"
                              placeholder="请详细说明退款原因"></textarea>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                <button type="button" class="btn btn-warning" onclick="confirmRefund()">确认退款</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
let currentPage = 1;
let pageSize = 20;
let currentOrderId = null;

// 页面加载完成后初始化
document.addEventListener('DOMContentLoaded', function() {
    loadOrders();
    loadOrderStats();
});

// 加载订单统计
function loadOrderStats() {
    fetch('/api/v1/admin/orders/stats')
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                document.getElementById('totalOrders').textContent = data.stats.total_orders || 0;
                document.getElementById('completedOrders').textContent = data.stats.completed_orders || 0;
                document.getElementById('totalRevenue').textContent = '¥' + (data.stats.total_revenue / 100).toFixed(2);
                document.getElementById('pendingOrders').textContent = data.stats.pending_orders || 0;
            }
        })
        .catch(error => {
            console.error('Error loading stats:', error);
        });
}

// 加载订单列表
function loadOrders(page = 1) {
    currentPage = page;
    const searchParams = new URLSearchParams();
    searchParams.append('page', page);
    searchParams.append('size', pageSize);

    // 添加筛选条件
    const orderId = document.getElementById('orderIdFilter').value;
    const platform = document.getElementById('platformFilter').value;
    const status = document.getElementById('statusFilter').value;
    const dateRange = document.getElementById('dateRangeFilter').value;

    if (orderId) searchParams.append('order_id', orderId);
    if (platform) searchParams.append('platform', platform);
    if (status) searchParams.append('status', status);
    if (dateRange) searchParams.append('date_range', dateRange);

    fetch(`/api/v1/admin/orders?${searchParams}`)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                renderOrders(data.orders);
                renderPagination(data.total, data.page, data.size);
                document.getElementById('orderCount').textContent = `总计: ${data.total} 订单`;
            } else {
                showError('加载订单列表失败: ' + data.message);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            showError('网络错误，请稍后重试');
        });
}

// 渲染订单列表
function renderOrders(orders) {
    const tbody = document.getElementById('ordersTableBody');

    if (orders.length === 0) {
        tbody.innerHTML = `
            <tr>
                <td colspan="9" class="text-center py-4">
                    <i class="fas fa-inbox fa-2x text-muted mb-3"></i>
                    <div>暂无订单数据</div>
                </td>
            </tr>
        `;
        return;
    }

    tbody.innerHTML = orders.map(order => `
        <tr>
            <td>
                <code>${order.order_id}</code>
                <i class="fas fa-copy ms-1 text-muted cursor-pointer"
                   onclick="copyToClipboard('${order.order_id}')"
                   title="复制订单号"></i>
            </td>
            <td>
                <code>${order.user_installation_id ? order.user_installation_id.substring(0, 8) + '...' : '-'}</code>
            </td>
            <td>
                <span class="badge ${getPlatformBadgeClass(order.platform)}">
                    ${getPlatformName(order.platform)}
                </span>
            </td>
            <td>${order.credits} 积分</td>
            <td>${order.amount_cents ? '¥' + (order.amount_cents / 100).toFixed(2) : '-'}</td>
            <td>
                <span class="badge ${getStatusBadgeClass(order.status)}">
                    ${getStatusName(order.status)}
                </span>
            </td>
            <td>${formatDateTime(order.created_at)}</td>
            <td>${order.completed_at ? formatDateTime(order.completed_at) : '-'}</td>
            <td>
                <div class="btn-group btn-group-sm" role="group">
                    <button type="button" class="btn btn-outline-info"
                            onclick="viewOrderDetail('${order.order_id}')"
                            title="查看详情">
                        <i class="fas fa-eye"></i>
                    </button>
                    ${order.status === 'completed' ? `
                        <button type="button" class="btn btn-outline-warning"
                                onclick="initiateRefund('${order.order_id}')"
                                title="申请退款">
                            <i class="fas fa-undo"></i>
                        </button>
                    ` : ''}
                </div>
            </td>
        </tr>
    `).join('');
}

// 渲染分页（复用用户管理页面的函数）
function renderPagination(total, page, size) {
    const totalPages = Math.ceil(total / size);
    const pagination = document.getElementById('pagination');

    let html = '';

    // 上一页
    html += `
        <li class="page-item ${page <= 1 ? 'disabled' : ''}">
            <a class="page-link" href="#" onclick="${page > 1 ? `loadOrders(${page - 1})` : 'return false'}">
                上一页
            </a>
        </li>
    `;

    // 页码
    const startPage = Math.max(1, page - 2);
    const endPage = Math.min(totalPages, page + 2);

    for (let i = startPage; i <= endPage; i++) {
        html += `
            <li class="page-item ${i === page ? 'active' : ''}">
                <a class="page-link" href="#" onclick="loadOrders(${i})">${i}</a>
            </li>
        `;
    }

    // 下一页
    html += `
        <li class="page-item ${page >= totalPages ? 'disabled' : ''}">
            <a class="page-link" href="#" onclick="${page < totalPages ? `loadOrders(${page + 1})` : 'return false'}">
                下一页
            </a>
        </li>
    `;

    pagination.innerHTML = html;
}

// 查看订单详情
function viewOrderDetail(orderId) {
    fetch(`/api/v1/admin/orders/${orderId}`)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                renderOrderDetail(data.order);
                currentOrderId = orderId;

                // 显示或隐藏退款按钮
                const refundBtn = document.getElementById('refundOrderBtn');
                if (data.order.status === 'completed') {
                    refundBtn.style.display = 'inline-block';
                } else {
                    refundBtn.style.display = 'none';
                }

                new bootstrap.Modal(document.getElementById('orderDetailModal')).show();
            } else {
                showError('加载订单详情失败: ' + data.message);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            showError('网络错误，请稍后重试');
        });
}

// 渲染订单详情
function renderOrderDetail(order) {
    document.getElementById('orderDetailContent').innerHTML = `
        <div class="row">
            <div class="col-md-6">
                <h6 class="fw-bold">订单信息</h6>
                <table class="table table-sm">
                    <tr><td>订单号:</td><td><code>${order.order_id}</code></td></tr>
                    <tr><td>支付平台:</td><td><span class="badge ${getPlatformBadgeClass(order.platform)}">${getPlatformName(order.platform)}</span></td></tr>
                    <tr><td>订单状态:</td><td><span class="badge ${getStatusBadgeClass(order.status)}">${getStatusName(order.status)}</span></td></tr>
                    <tr><td>创建时间:</td><td>${formatDateTime(order.created_at)}</td></tr>
                    <tr><td>完成时间:</td><td>${order.completed_at ? formatDateTime(order.completed_at) : '-'}</td></tr>
                </table>
            </div>
            <div class="col-md-6">
                <h6 class="fw-bold">商品信息</h6>
                <table class="table table-sm">
                    <tr><td>积分数量:</td><td><span class="badge bg-success">${order.credits} 积分</span></td></tr>
                    <tr><td>支付金额:</td><td>${order.amount_cents ? '¥' + (order.amount_cents / 100).toFixed(2) : '-'}</td></tr>
                    <tr><td>货币单位:</td><td>${order.currency || '-'}</td></tr>
                    <tr><td>用户ID:</td><td><code>${order.user_installation_id || '-'}</code></td></tr>
                </table>
            </div>
        </div>

        ${order.purchase_token ? `
            <hr>
            <h6 class="fw-bold">支付凭证</h6>
            <div class="alert alert-info">
                <small><strong>Purchase Token:</strong></small><br>
                <code style="word-break: break-all;">${order.purchase_token}</code>
            </div>
        ` : ''}

        ${order.redeem_code ? `
            <hr>
            <h6 class="fw-bold">兑换码信息</h6>
            <div class="alert alert-success">
                <strong>兑换码:</strong> <code>${order.redeem_code}</code>
            </div>
        ` : ''}

        <hr>
        <h6 class="fw-bold">处理日志</h6>
        <div class="timeline">
            <div class="timeline-item">
                <i class="fas fa-plus-circle text-info"></i>
                <span class="timeline-time">${formatDateTime(order.created_at)}</span>
                <span class="timeline-content">订单创建</span>
            </div>
            ${order.completed_at ? `
                <div class="timeline-item">
                    <i class="fas fa-check-circle text-success"></i>
                    <span class="timeline-time">${formatDateTime(order.completed_at)}</span>
                    <span class="timeline-content">订单完成</span>
                </div>
            ` : ''}
        </div>
    `;
}

// 搜索订单
function searchOrders() {
    loadOrders(1);
}

// 刷新订单
function refreshOrders() {
    loadOrders(currentPage);
    loadOrderStats();
}

// 发起退款
function initiateRefund(orderId) {
    currentOrderId = orderId;
    document.getElementById('refundReason').value = '';
    new bootstrap.Modal(document.getElementById('refundModal')).show();
}

// 确认退款
function confirmRefund() {
    const reason = document.getElementById('refundReason').value;
    if (!reason.trim()) {
        showError('请输入退款原因');
        return;
    }

    fetch(`/api/v1/admin/orders/${currentOrderId}/refund`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            reason: reason
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showSuccess('退款申请已提交');
            bootstrap.Modal.getInstance(document.getElementById('refundModal')).hide();
            bootstrap.Modal.getInstance(document.getElementById('orderDetailModal')).hide();
            loadOrders(currentPage);
            loadOrderStats();
        } else {
            showError('退款申请失败: ' + data.message);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showError('网络错误，请稍后重试');
    });
}

// 导出订单
function exportOrders() {
    const searchParams = new URLSearchParams();
    const orderId = document.getElementById('orderIdFilter').value;
    const platform = document.getElementById('platformFilter').value;
    const status = document.getElementById('statusFilter').value;
    const dateRange = document.getElementById('dateRangeFilter').value;

    if (orderId) searchParams.append('order_id', orderId);
    if (platform) searchParams.append('platform', platform);
    if (status) searchParams.append('status', status);
    if (dateRange) searchParams.append('date_range', dateRange);

    window.open(`/api/v1/admin/orders/export?${searchParams}`, '_blank');
}

// 工具函数
function formatDateTime(dateString) {
    return new Date(dateString).toLocaleString('zh-CN');
}

function copyToClipboard(text) {
    navigator.clipboard.writeText(text).then(() => {
        showSuccess('已复制到剪贴板');
    });
}

function getPlatformName(platform) {
    const names = {
        'google_play': 'Google Play',
        'redeem_code': '兑换码',
        'app_store': 'App Store'
    };
    return names[platform] || platform;
}

function getPlatformBadgeClass(platform) {
    const classes = {
        'google_play': 'bg-success',
        'redeem_code': 'bg-primary',
        'app_store': 'bg-info'
    };
    return classes[platform] || 'bg-secondary';
}

function getStatusName(status) {
    const names = {
        'pending': '待处理',
        'completed': '已完成',
        'failed': '失败',
        'refunded': '已退款'
    };
    return names[status] || status;
}

function getStatusBadgeClass(status) {
    const classes = {
        'pending': 'bg-warning',
        'completed': 'bg-success',
        'failed': 'bg-danger',
        'refunded': 'bg-secondary'
    };
    return classes[status] || 'bg-secondary';
}

function showSuccess(message) {
    // TODO: 实现成功提示
    alert('成功: ' + message);
}

function showError(message) {
    // TODO: 实现错误提示
    alert('错误: ' + message);
}
</script>

<style>
.timeline {
    position: relative;
    padding: 1rem 0;
}

.timeline-item {
    display: flex;
    align-items: center;
    margin-bottom: 0.5rem;
}

.timeline-item i {
    margin-right: 0.5rem;
}

.timeline-time {
    font-size: 0.875rem;
    color: #6c757d;
    margin-right: 1rem;
    min-width: 140px;
}

.timeline-content {
    font-weight: 500;
}

.cursor-pointer {
    cursor: pointer;
}
</style>
{% endblock %}