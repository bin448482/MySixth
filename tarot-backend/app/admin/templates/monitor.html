{% extends "base.html" %}

{% block title %}系统监控 - 塔罗牌应用管理后台{% endblock %}
{% block page_title %}系统监控{% endblock %}

{% block page_actions %}
<button type="button" class="btn btn-outline-secondary" onclick="refreshAll()">
    <i class="fas fa-sync-alt me-2"></i>刷新全部
</button>
<button type="button" class="btn btn-outline-info" onclick="toggleAutoRefresh()">
    <i class="fas fa-play me-2" id="autoRefreshIcon"></i>
    <span id="autoRefreshText">自动刷新</span>
</button>
{% endblock %}

{% block content %}
<!-- 系统状态总览 -->
<div class="row mb-4">
    <div class="col-md-3">
        <div class="card stats-card border-start border-success border-4">
            <div class="card-body">
                <div class="d-flex align-items-center">
                    <div class="flex-grow-1">
                        <div class="metric-value text-success" id="systemStatus">
                            <i class="fas fa-check-circle"></i>
                        </div>
                        <div class="metric-label">系统状态</div>
                        <div class="metric-change" id="uptime">运行时间: 计算中...</div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card stats-card border-start border-info border-4">
            <div class="card-body">
                <div class="d-flex align-items-center">
                    <div class="flex-grow-1">
                        <div class="metric-value text-info" id="dbStatus">
                            <i class="fas fa-database"></i>
                        </div>
                        <div class="metric-label">数据库状态</div>
                        <div class="metric-change" id="dbConnections">连接数: 0</div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card stats-card border-start border-warning border-4">
            <div class="card-body">
                <div class="d-flex align-items-center">
                    <div class="flex-grow-1">
                        <div class="metric-value text-warning" id="apiStatus">
                            <i class="fas fa-plug"></i>
                        </div>
                        <div class="metric-label">API状态</div>
                        <div class="metric-change" id="apiResponse">响应时间: 0ms</div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card stats-card border-start border-primary border-4">
            <div class="card-body">
                <div class="d-flex align-items-center">
                    <div class="flex-grow-1">
                        <div class="metric-value text-primary" id="llmStatus">
                            <i class="fas fa-robot"></i>
                        </div>
                        <div class="metric-label">LLM服务</div>
                        <div class="metric-change" id="llmResponse">响应时间: 0ms</div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- 性能指标图表 -->
<div class="row mb-4">
    <div class="col-md-6">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="fas fa-chart-line me-2"></i>CPU & 内存使用率
                </h5>
            </div>
            <div class="card-body">
                <div class="chart-container">
                    <canvas id="performanceChart"></canvas>
                </div>
            </div>
        </div>
    </div>
    <div class="col-md-6">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="fas fa-tachometer-alt me-2"></i>API响应时间
                </h5>
            </div>
            <div class="card-body">
                <div class="chart-container">
                    <canvas id="responseTimeChart"></canvas>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- 服务状态详情 -->
<div class="row mb-4">
    <div class="col-md-6">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="fas fa-server me-2"></i>服务状态检查
                </h5>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-sm">
                        <thead>
                            <tr>
                                <th>服务</th>
                                <th>状态</th>
                                <th>响应时间</th>
                                <th>最后检查</th>
                            </tr>
                        </thead>
                        <tbody id="serviceStatusTable">
                            <tr>
                                <td>FastAPI</td>
                                <td><span class="badge bg-success">正常</span></td>
                                <td>--ms</td>
                                <td>--</td>
                            </tr>
                            <tr>
                                <td>SQLite数据库</td>
                                <td><span class="badge bg-success">正常</span></td>
                                <td>--ms</td>
                                <td>--</td>
                            </tr>
                            <tr>
                                <td>智谱AI</td>
                                <td><span class="badge bg-warning">检查中</span></td>
                                <td>--ms</td>
                                <td>--</td>
                            </tr>
                            <tr>
                                <td>OpenAI</td>
                                <td><span class="badge bg-warning">检查中</span></td>
                                <td>--ms</td>
                                <td>--</td>
                            </tr>
                            <tr>
                                <td>Google Play API</td>
                                <td><span class="badge bg-secondary">已禁用</span></td>
                                <td>--</td>
                                <td>--</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
    <div class="col-md-6">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="fas fa-chart-bar me-2"></i>实时统计
                </h5>
            </div>
            <div class="card-body">
                <div class="row text-center">
                    <div class="col-6">
                        <div class="border-end">
                            <div class="h4 mb-0" id="requestsPerMinute">0</div>
                            <small class="text-muted">请求/分钟</small>
                        </div>
                    </div>
                    <div class="col-6">
                        <div class="h4 mb-0" id="errorsPerMinute">0</div>
                        <small class="text-muted">错误/分钟</small>
                    </div>
                </div>
                <hr>
                <div class="row text-center">
                    <div class="col-6">
                        <div class="border-end">
                            <div class="h4 mb-0" id="activeUsers">0</div>
                            <small class="text-muted">活跃用户</small>
                        </div>
                    </div>
                    <div class="col-6">
                        <div class="h4 mb-0" id="llmCalls">0</div>
                        <small class="text-muted">LLM调用</small>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- 错误日志和告警 -->
<div class="row mb-4">
    <div class="col-md-8">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0">
                    <i class="fas fa-exclamation-triangle me-2"></i>最近错误日志
                </h5>
                <div class="btn-group btn-group-sm" role="group">
                    <button type="button" class="btn btn-outline-secondary" onclick="clearLogs()">
                        <i class="fas fa-trash"></i> 清空
                    </button>
                    <button type="button" class="btn btn-outline-primary" onclick="downloadLogs()">
                        <i class="fas fa-download"></i> 下载
                    </button>
                </div>
            </div>
            <div class="card-body">
                <div style="max-height: 400px; overflow-y: auto;" id="errorLogsContainer">
                    <div class="text-center py-4">
                        <div class="spinner-border" role="status">
                            <span class="visually-hidden">加载中...</span>
                        </div>
                        <div class="mt-2">正在加载错误日志...</div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="col-md-4">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="fas fa-bell me-2"></i>系统告警
                </h5>
            </div>
            <div class="card-body">
                <div id="alertsContainer">
                    <!-- 告警信息将在这里显示 -->
                    <div class="alert alert-success" role="alert">
                        <i class="fas fa-check-circle me-2"></i>
                        所有系统运行正常
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- 系统信息 -->
<div class="row">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="fas fa-info-circle me-2"></i>系统信息
                </h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-3">
                        <strong>应用版本:</strong>
                        <div class="text-muted" id="appVersion">1.0.0</div>
                    </div>
                    <div class="col-md-3">
                        <strong>Python版本:</strong>
                        <div class="text-muted" id="pythonVersion">--</div>
                    </div>
                    <div class="col-md-3">
                        <strong>FastAPI版本:</strong>
                        <div class="text-muted" id="fastapiVersion">--</div>
                    </div>
                    <div class="col-md-3">
                        <strong>启动时间:</strong>
                        <div class="text-muted" id="startTime">--</div>
                    </div>
                </div>
                <hr>
                <div class="row">
                    <div class="col-md-3">
                        <strong>CPU核心数:</strong>
                        <div class="text-muted" id="cpuCores">--</div>
                    </div>
                    <div class="col-md-3">
                        <strong>内存总量:</strong>
                        <div class="text-muted" id="totalMemory">--</div>
                    </div>
                    <div class="col-md-3">
                        <strong>磁盘空间:</strong>
                        <div class="text-muted" id="diskSpace">--</div>
                    </div>
                    <div class="col-md-3">
                        <strong>数据库大小:</strong>
                        <div class="text-muted" id="dbSize">--</div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
let performanceChart, responseTimeChart;
let autoRefreshInterval = null;
let isAutoRefreshEnabled = false;

// 页面加载完成后初始化
document.addEventListener('DOMContentLoaded', function() {
    initializeCharts();
    loadMonitorData();

    // 每30秒自动刷新一次
    setInterval(loadMonitorData, 30000);
});

// 初始化图表
function initializeCharts() {
    // 性能监控图表
    const performanceCtx = document.getElementById('performanceChart').getContext('2d');
    performanceChart = new Chart(performanceCtx, {
        type: 'line',
        data: {
            labels: [],
            datasets: [{
                label: 'CPU使用率 (%)',
                data: [],
                borderColor: 'rgb(255, 99, 132)',
                backgroundColor: 'rgba(255, 99, 132, 0.2)',
                tension: 0.1
            }, {
                label: '内存使用率 (%)',
                data: [],
                borderColor: 'rgb(54, 162, 235)',
                backgroundColor: 'rgba(54, 162, 235, 0.2)',
                tension: 0.1
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                y: {
                    beginAtZero: true,
                    max: 100,
                    ticks: {
                        callback: function(value) {
                            return value + '%';
                        }
                    }
                }
            }
        }
    });

    // API响应时间图表
    const responseTimeCtx = document.getElementById('responseTimeChart').getContext('2d');
    responseTimeChart = new Chart(responseTimeCtx, {
        type: 'line',
        data: {
            labels: [],
            datasets: [{
                label: 'API响应时间 (ms)',
                data: [],
                borderColor: 'rgb(75, 192, 192)',
                backgroundColor: 'rgba(75, 192, 192, 0.2)',
                tension: 0.1
            }, {
                label: 'LLM响应时间 (ms)',
                data: [],
                borderColor: 'rgb(153, 102, 255)',
                backgroundColor: 'rgba(153, 102, 255, 0.2)',
                tension: 0.1
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                y: {
                    beginAtZero: true,
                    ticks: {
                        callback: function(value) {
                            return value + 'ms';
                        }
                    }
                }
            }
        }
    });
}

// 加载监控数据
function loadMonitorData() {
    Promise.all([
        loadSystemStatus(),
        loadPerformanceMetrics(),
        loadServiceStatus(),
        loadErrorLogs(),
        loadSystemInfo()
    ]).catch(error => {
        console.error('Error loading monitor data:', error);
    });
}

// 加载系统状态
function loadSystemStatus() {
    return fetch('/api/v1/admin/monitor/status')
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                updateSystemStatus(data.status);
            }
        })
        .catch(error => {
            console.error('Error loading system status:', error);
            // 设置为错误状态
            updateSystemStatus({
                system: 'error',
                database: 'error',
                api: 'error',
                llm: 'error'
            });
        });
}

// 更新系统状态显示
function updateSystemStatus(status) {
    // 系统状态
    const systemElement = document.getElementById('systemStatus');
    if (status.system === 'healthy') {
        systemElement.innerHTML = '<i class="fas fa-check-circle"></i>';
        systemElement.className = 'metric-value text-success';
    } else {
        systemElement.innerHTML = '<i class="fas fa-times-circle"></i>';
        systemElement.className = 'metric-value text-danger';
    }

    // 数据库状态
    const dbElement = document.getElementById('dbStatus');
    if (status.database === 'healthy') {
        dbElement.innerHTML = '<i class="fas fa-database"></i>';
        dbElement.className = 'metric-value text-success';
    } else {
        dbElement.innerHTML = '<i class="fas fa-database"></i>';
        dbElement.className = 'metric-value text-danger';
    }

    // API状态
    const apiElement = document.getElementById('apiStatus');
    if (status.api === 'healthy') {
        apiElement.innerHTML = '<i class="fas fa-plug"></i>';
        apiElement.className = 'metric-value text-success';
    } else {
        apiElement.innerHTML = '<i class="fas fa-plug"></i>';
        apiElement.className = 'metric-value text-danger';
    }

    // LLM状态
    const llmElement = document.getElementById('llmStatus');
    if (status.llm === 'healthy') {
        llmElement.innerHTML = '<i class="fas fa-robot"></i>';
        llmElement.className = 'metric-value text-success';
    } else {
        llmElement.innerHTML = '<i class="fas fa-robot"></i>';
        llmElement.className = 'metric-value text-warning';
    }

    // 更新统计信息
    if (status.stats) {
        document.getElementById('uptime').textContent = `运行时间: ${status.stats.uptime || '计算中...'}`;
        document.getElementById('dbConnections').textContent = `连接数: ${status.stats.db_connections || 0}`;
        document.getElementById('apiResponse').textContent = `响应时间: ${status.stats.api_response_time || 0}ms`;
        document.getElementById('llmResponse').textContent = `响应时间: ${status.stats.llm_response_time || 0}ms`;

        // 更新实时统计
        document.getElementById('requestsPerMinute').textContent = status.stats.requests_per_minute || 0;
        document.getElementById('errorsPerMinute').textContent = status.stats.errors_per_minute || 0;
        document.getElementById('activeUsers').textContent = status.stats.active_users || 0;
        document.getElementById('llmCalls').textContent = status.stats.llm_calls || 0;
    }
}

// 加载性能指标
function loadPerformanceMetrics() {
    return fetch('/api/v1/admin/monitor/performance')
        .then(response => response.json())
        .then(data => {
            if (data.success && data.metrics) {
                updatePerformanceCharts(data.metrics);
            }
        })
        .catch(error => {
            console.error('Error loading performance metrics:', error);
        });
}

// 更新性能图表
function updatePerformanceCharts(metrics) {
    if (metrics.performance) {
        const now = new Date().toLocaleTimeString();

        // 更新性能图表
        performanceChart.data.labels.push(now);
        performanceChart.data.datasets[0].data.push(metrics.performance.cpu_usage || 0);
        performanceChart.data.datasets[1].data.push(metrics.performance.memory_usage || 0);

        // 保持最近20个数据点
        if (performanceChart.data.labels.length > 20) {
            performanceChart.data.labels.shift();
            performanceChart.data.datasets[0].data.shift();
            performanceChart.data.datasets[1].data.shift();
        }

        performanceChart.update('none'); // 无动画更新
    }

    if (metrics.response_times) {
        const now = new Date().toLocaleTimeString();

        // 更新响应时间图表
        responseTimeChart.data.labels.push(now);
        responseTimeChart.data.datasets[0].data.push(metrics.response_times.api || 0);
        responseTimeChart.data.datasets[1].data.push(metrics.response_times.llm || 0);

        // 保持最近20个数据点
        if (responseTimeChart.data.labels.length > 20) {
            responseTimeChart.data.labels.shift();
            responseTimeChart.data.datasets[0].data.shift();
            responseTimeChart.data.datasets[1].data.shift();
        }

        responseTimeChart.update('none'); // 无动画更新
    }
}

// 加载服务状态
function loadServiceStatus() {
    return fetch('/api/v1/admin/monitor/services')
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                updateServiceStatusTable(data.services);
            }
        })
        .catch(error => {
            console.error('Error loading service status:', error);
        });
}

// 更新服务状态表
function updateServiceStatusTable(services) {
    const tbody = document.getElementById('serviceStatusTable');
    tbody.innerHTML = services.map(service => `
        <tr>
            <td>${service.name}</td>
            <td><span class="badge ${getStatusBadgeClass(service.status)}">${getStatusText(service.status)}</span></td>
            <td>${service.response_time ? service.response_time + 'ms' : '--'}</td>
            <td>${service.last_check ? formatTime(service.last_check) : '--'}</td>
        </tr>
    `).join('');
}

// 加载错误日志
function loadErrorLogs() {
    return fetch('/api/v1/admin/monitor/logs?level=error&limit=50')
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                updateErrorLogs(data.logs);
            }
        })
        .catch(error => {
            console.error('Error loading error logs:', error);
            document.getElementById('errorLogsContainer').innerHTML = `
                <div class="alert alert-warning">
                    <i class="fas fa-exclamation-triangle me-2"></i>
                    无法加载错误日志
                </div>
            `;
        });
}

// 更新错误日志显示
function updateErrorLogs(logs) {
    const container = document.getElementById('errorLogsContainer');

    if (!logs || logs.length === 0) {
        container.innerHTML = `
            <div class="alert alert-success">
                <i class="fas fa-check-circle me-2"></i>
                暂无错误日志
            </div>
        `;
        return;
    }

    container.innerHTML = logs.map(log => `
        <div class="alert alert-danger alert-sm" role="alert">
            <div class="d-flex justify-content-between">
                <strong>${log.level}</strong>
                <small class="text-muted">${formatTime(log.timestamp)}</small>
            </div>
            <div class="mt-1">
                <strong>${log.logger}:</strong> ${log.message}
            </div>
            ${log.stack_trace ? `
                <details class="mt-2">
                    <summary class="text-muted" style="cursor: pointer;">详细堆栈信息</summary>
                    <pre class="mt-2 mb-0" style="font-size: 0.8rem;">${log.stack_trace}</pre>
                </details>
            ` : ''}
        </div>
    `).join('');
}

// 加载系统信息
function loadSystemInfo() {
    return fetch('/api/v1/admin/monitor/system-info')
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                updateSystemInfo(data.info);
            }
        })
        .catch(error => {
            console.error('Error loading system info:', error);
        });
}

// 更新系统信息
function updateSystemInfo(info) {
    document.getElementById('appVersion').textContent = info.app_version || '1.0.0';
    document.getElementById('pythonVersion').textContent = info.python_version || '--';
    document.getElementById('fastapiVersion').textContent = info.fastapi_version || '--';
    document.getElementById('startTime').textContent = info.start_time || '--';
    document.getElementById('cpuCores').textContent = info.cpu_cores || '--';
    document.getElementById('totalMemory').textContent = info.total_memory || '--';
    document.getElementById('diskSpace').textContent = info.disk_space || '--';
    document.getElementById('dbSize').textContent = info.db_size || '--';
}

// 刷新所有数据
function refreshAll() {
    loadMonitorData();
    showSuccess('数据已刷新');
}

// 切换自动刷新
function toggleAutoRefresh() {
    if (isAutoRefreshEnabled) {
        // 停止自动刷新
        clearInterval(autoRefreshInterval);
        autoRefreshInterval = null;
        isAutoRefreshEnabled = false;
        document.getElementById('autoRefreshIcon').className = 'fas fa-play me-2';
        document.getElementById('autoRefreshText').textContent = '自动刷新';
    } else {
        // 开始自动刷新
        autoRefreshInterval = setInterval(loadMonitorData, 10000); // 10秒刷新一次
        isAutoRefreshEnabled = true;
        document.getElementById('autoRefreshIcon').className = 'fas fa-pause me-2';
        document.getElementById('autoRefreshText').textContent = '停止刷新';
    }
}

// 清空日志
function clearLogs() {
    if (confirm('确定要清空错误日志吗？此操作不可撤销。')) {
        fetch('/api/v1/admin/monitor/logs', {
            method: 'DELETE'
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showSuccess('日志已清空');
                loadErrorLogs();
            } else {
                showError('清空日志失败: ' + data.message);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            showError('网络错误，请稍后重试');
        });
    }
}

// 下载日志
function downloadLogs() {
    window.open('/api/v1/admin/monitor/logs/download', '_blank');
}

// 工具函数
function getStatusBadgeClass(status) {
    const classes = {
        'healthy': 'bg-success',
        'warning': 'bg-warning',
        'error': 'bg-danger',
        'disabled': 'bg-secondary'
    };
    return classes[status] || 'bg-secondary';
}

function getStatusText(status) {
    const texts = {
        'healthy': '正常',
        'warning': '警告',
        'error': '错误',
        'disabled': '已禁用'
    };
    return texts[status] || '未知';
}

function formatTime(timestamp) {
    return new Date(timestamp).toLocaleString('zh-CN');
}

function showSuccess(message) {
    // TODO: 实现成功提示
    console.log('Success:', message);
}

function showError(message) {
    // TODO: 实现错误提示
    console.error('Error:', message);
    alert('错误: ' + message);
}
</script>

<style>
.alert-sm {
    padding: 0.5rem 0.75rem;
    font-size: 0.875rem;
    margin-bottom: 0.5rem;
}

.chart-container {
    position: relative;
    height: 300px;
}

#errorLogsContainer {
    max-height: 400px;
    overflow-y: auto;
}
</style>
{% endblock %}