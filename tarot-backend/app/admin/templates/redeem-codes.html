{% extends "base.html" %}

{% block title %}兑换码管理 - 塔罗牌应用管理后台{% endblock %}
{% block page_title %}兑换码管理{% endblock %}

{% block page_actions %}
<button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#generateCodesModal">
    <i class="fas fa-plus me-2"></i>批量生成
</button>
<button type="button" class="btn btn-outline-secondary" onclick="exportCodes()">
    <i class="fas fa-download me-2"></i>导出兑换码
</button>
{% endblock %}

{% block content %}
<div class="row mb-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="fas fa-filter me-2"></i>筛选条件
                </h5>
            </div>
            <div class="card-body">
                <form id="filterForm" class="row g-3">
                    <div class="col-md-3">
                        <label for="codeFilter" class="form-label">兑换码</label>
                        <input type="text" class="form-control" id="codeFilter"
                               placeholder="输入兑换码">
                    </div>
                    <div class="col-md-2">
                        <label for="statusFilter" class="form-label">状态</label>
                        <select class="form-select" id="statusFilter">
                            <option value="">全部状态</option>
                            <option value="active">可用</option>
                            <option value="used">已使用</option>
                            <option value="expired">已过期</option>
                            <option value="disabled">已禁用</option>
                        </select>
                    </div>
                    <div class="col-md-2">
                        <label for="batchFilter" class="form-label">批次</label>
                        <select class="form-select" id="batchFilter">
                            <option value="">全部批次</option>
                            <!-- 动态加载批次选项 -->
                        </select>
                    </div>
                    <div class="col-md-3">
                        <label for="dateRangeFilter" class="form-label">创建时间</label>
                        <select class="form-select" id="dateRangeFilter">
                            <option value="">全部时间</option>
                            <option value="today">今天</option>
                            <option value="week">本周</option>
                            <option value="month">本月</option>
                        </select>
                    </div>
                    <div class="col-md-2">
                        <label class="form-label">&nbsp;</label>
                        <button type="button" class="btn btn-primary d-block w-100" onclick="searchCodes()">
                            <i class="fas fa-search"></i> 搜索
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- 统计卡片 -->
<div class="row mb-4">
    <div class="col-md-3">
        <div class="card stats-card border-start border-success border-4">
            <div class="card-body">
                <div class="d-flex align-items-center">
                    <div class="flex-grow-1">
                        <div class="metric-value text-success" id="activeCodes">0</div>
                        <div class="metric-label">可用兑换码</div>
                    </div>
                    <div class="text-success">
                        <i class="fas fa-ticket-alt fa-2x"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card stats-card border-start border-warning border-4">
            <div class="card-body">
                <div class="d-flex align-items-center">
                    <div class="flex-grow-1">
                        <div class="metric-value text-warning" id="usedCodes">0</div>
                        <div class="metric-label">已使用</div>
                    </div>
                    <div class="text-warning">
                        <i class="fas fa-check-circle fa-2x"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card stats-card border-start border-danger border-4">
            <div class="card-body">
                <div class="d-flex align-items-center">
                    <div class="flex-grow-1">
                        <div class="metric-value text-danger" id="expiredCodes">0</div>
                        <div class="metric-label">已过期</div>
                    </div>
                    <div class="text-danger">
                        <i class="fas fa-times-circle fa-2x"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card stats-card border-start border-info border-4">
            <div class="card-body">
                <div class="d-flex align-items-center">
                    <div class="flex-grow-1">
                        <div class="metric-value text-info" id="usageRate">0%</div>
                        <div class="metric-label">使用率</div>
                    </div>
                    <div class="text-info">
                        <i class="fas fa-chart-pie fa-2x"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="row">
    <div class="col-12">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0">
                    <i class="fas fa-list me-2"></i>兑换码列表
                </h5>
                <span class="badge bg-secondary" id="codeCount">总计: 0 兑换码</span>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead class="table-light">
                            <tr>
                                <th>兑换码</th>
                                <th>积分值</th>
                                <th>状态</th>
                                <th>批次</th>
                                <th>使用者</th>
                                <th>创建时间</th>
                                <th>过期时间</th>
                                <th>使用时间</th>
                                <th>操作</th>
                            </tr>
                        </thead>
                        <tbody id="codesTableBody">
                            <tr>
                                <td colspan="9" class="text-center py-4">
                                    <div class="spinner-border" role="status">
                                        <span class="visually-hidden">加载中...</span>
                                    </div>
                                    <div class="mt-2">正在加载兑换码数据...</div>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>

                <!-- 分页 -->
                <nav aria-label="兑换码分页">
                    <ul class="pagination justify-content-center" id="pagination">
                        <li class="page-item disabled">
                            <span class="page-link">上一页</span>
                        </li>
                        <li class="page-item active">
                            <span class="page-link">1</span>
                        </li>
                        <li class="page-item disabled">
                            <span class="page-link">下一页</span>
                        </li>
                    </ul>
                </nav>
            </div>
        </div>
    </div>
</div>

<!-- 批量生成兑换码模态框 -->
<div class="modal fade" id="generateCodesModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-magic me-2"></i>批量生成兑换码
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form id="generateCodesForm">
                <div class="modal-body">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="generateCredits" class="form-label">积分值</label>
                                <select class="form-select" id="generateCredits" required>
                                    <option value="">选择积分数量</option>
                                    <option value="1">1 积分</option>
                                    <option value="5">5 积分</option>
                                    <option value="10">10 积分</option>
                                    <option value="20">20 积分</option>
                                    <option value="50">50 积分</option>
                                    <option value="100">100 积分</option>
                                </select>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="generateQuantity" class="form-label">生成数量</label>
                                <input type="number" class="form-control" id="generateQuantity"
                                       min="1" max="1000" value="10" required>
                                <div class="form-text">最多一次生成1000个</div>
                            </div>
                        </div>
                    </div>

                    <div class="mb-3">
                        <label for="generateBatch" class="form-label">批次名称</label>
                        <input type="text" class="form-control" id="generateBatch"
                               placeholder="例如: 新用户福利-20241001">
                        <div class="form-text">用于管理和区分不同批次的兑换码</div>
                    </div>

                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="generateExpiryDays" class="form-label">有效期</label>
                                <select class="form-select" id="generateExpiryDays">
                                    <option value="0">永不过期</option>
                                    <option value="7">7 天</option>
                                    <option value="30">30 天</option>
                                    <option value="90">90 天</option>
                                    <option value="365">365 天</option>
                                </select>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="generatePrefix" class="form-label">前缀</label>
                                <input type="text" class="form-control" id="generatePrefix"
                                       value="TAROT" maxlength="10">
                                <div class="form-text">兑换码前缀，便于识别</div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-magic me-2"></i>开始生成
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- 生成进度模态框 -->
<div class="modal fade" id="generateProgressModal" tabindex="-1" data-bs-backdrop="static">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-cog fa-spin me-2"></i>正在生成兑换码
                </h5>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <div class="progress">
                        <div class="progress-bar progress-bar-striped progress-bar-animated"
                             id="generateProgress" style="width: 0%"></div>
                    </div>
                </div>
                <div class="text-center">
                    <div id="generateStatus">准备生成兑换码...</div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- 批量操作模态框 -->
<div class="modal fade" id="batchOperationModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-tasks me-2"></i>批量操作
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <label for="batchOperationType" class="form-label">操作类型</label>
                    <select class="form-select" id="batchOperationType">
                        <option value="disable">禁用兑换码</option>
                        <option value="enable">启用兑换码</option>
                        <option value="extend_expiry">延长有效期</option>
                    </select>
                </div>

                <div class="mb-3" id="extendExpirySection" style="display: none;">
                    <label for="extendDays" class="form-label">延长天数</label>
                    <input type="number" class="form-control" id="extendDays" min="1" max="365" value="30">
                </div>

                <div class="mb-3">
                    <label for="batchTargetBatch" class="form-label">目标批次</label>
                    <select class="form-select" id="batchTargetBatch">
                        <option value="">选择批次</option>
                        <!-- 动态加载批次选项 -->
                    </select>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                <button type="button" class="btn btn-warning" onclick="executeBatchOperation()">执行操作</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
let currentPage = 1;
let pageSize = 20;

// 页面加载完成后初始化
document.addEventListener('DOMContentLoaded', function() {
    loadCodes();
    loadCodeStats();
    loadBatches();

    // 监听操作类型变化
    document.getElementById('batchOperationType').addEventListener('change', function() {
        const extendSection = document.getElementById('extendExpirySection');
        if (this.value === 'extend_expiry') {
            extendSection.style.display = 'block';
        } else {
            extendSection.style.display = 'none';
        }
    });
});

// 加载兑换码统计
function loadCodeStats() {
    fetch('/api/v1/admin/redeem-codes/stats', {
        credentials: 'include'
    })
        .then(response => {
            if (response.status === 401 || response.status === 403) {
                // 认证失败，重定向到登录页面
                window.location.href = '/admin/login';
                return;
            }
            return response.json();
        })
        .then(data => {
            if (!data) return; // 如果被重定向，data为undefined

            if (data.success) {
                document.getElementById('activeCodes').textContent = data.stats.active || 0;
                document.getElementById('usedCodes').textContent = data.stats.used || 0;
                document.getElementById('expiredCodes').textContent = data.stats.expired || 0;

                const total = data.stats.active + data.stats.used + data.stats.expired + (data.stats.disabled || 0);
                const usageRate = total > 0 ? Math.round((data.stats.used / total) * 100) : 0;
                document.getElementById('usageRate').textContent = usageRate + '%';
            }
        })
        .catch(error => {
            console.error('Error loading stats:', error);
        });
}

// 加载批次选项
function loadBatches() {
    fetch('/api/v1/admin/redeem-codes/batches', {
        credentials: 'include'
    })
        .then(response => {
            if (response.status === 401 || response.status === 403) {
                // 认证失败，重定向到登录页面
                window.location.href = '/admin/login';
                return;
            }
            return response.json();
        })
        .then(data => {
            if (!data) return; // 如果被重定向，data为undefined

            if (data.success) {
                const batchFilter = document.getElementById('batchFilter');
                const batchTargetBatch = document.getElementById('batchTargetBatch');

                // 清空现有选项（保留第一个默认选项）
                batchFilter.innerHTML = '<option value="">全部批次</option>';
                batchTargetBatch.innerHTML = '<option value="">选择批次</option>';

                data.batches.forEach(batch => {
                    const option1 = new Option(batch, batch);
                    const option2 = new Option(batch, batch);
                    batchFilter.appendChild(option1);
                    batchTargetBatch.appendChild(option2);
                });
            }
        })
        .catch(error => {
            console.error('Error loading batches:', error);
        });
}

// 加载兑换码列表
function loadCodes(page = 1) {
    currentPage = page;
    const searchParams = new URLSearchParams();
    searchParams.append('page', page);
    searchParams.append('size', pageSize);

    // 添加筛选条件
    const code = document.getElementById('codeFilter').value;
    const status = document.getElementById('statusFilter').value;
    const batch = document.getElementById('batchFilter').value;
    const dateRange = document.getElementById('dateRangeFilter').value;

    if (code) searchParams.append('code', code);
    if (status) searchParams.append('status', status);
    if (batch) searchParams.append('batch_id', batch);
    if (dateRange) searchParams.append('date_range', dateRange);

    fetch(`/api/v1/admin/redeem-codes?${searchParams}`, {
        credentials: 'include'
    })
        .then(response => {
            if (response.status === 401 || response.status === 403) {
                // 认证失败，重定向到登录页面
                window.location.href = '/admin/login';
                return;
            }
            return response.json();
        })
        .then(data => {
            if (!data) return; // 如果被重定向，data为undefined

            if (data.success) {
                renderCodes(data.redeem_codes);
                renderPagination(data.total, data.page, data.size);
                document.getElementById('codeCount').textContent = `总计: ${data.total} 兑换码`;
            } else {
                showError('加载兑换码列表失败: ' + (data.detail || data.message || '未知错误'));
            }
        })
        .catch(error => {
            console.error('Error:', error);
            showError('网络错误，请稍后重试');
        });
}

// 渲染兑换码列表
function renderCodes(codes) {
    const tbody = document.getElementById('codesTableBody');

    if (codes.length === 0) {
        tbody.innerHTML = `
            <tr>
                <td colspan="9" class="text-center py-4">
                    <i class="fas fa-inbox fa-2x text-muted mb-3"></i>
                    <div>暂无兑换码数据</div>
                </td>
            </tr>
        `;
        return;
    }

    tbody.innerHTML = codes.map(code => `
        <tr>
            <td>
                <code>${code.code}</code>
                <i class="fas fa-copy ms-1 text-muted cursor-pointer"
                   onclick="copyToClipboard('${code.code}')"
                   title="复制兑换码"></i>
            </td>
            <td><span class="badge bg-success">${code.credits} 积分</span></td>
            <td>
                <span class="badge ${getStatusBadgeClass(code.status)}">
                    ${getStatusName(code.status)}
                </span>
            </td>
            <td>${code.batch_id || '-'}</td>
            <td>
                ${code.used_by_user ? `<code>${code.used_by_user.installation_id.substring(0, 8)}...</code>` : '-'}
            </td>
            <td>${formatDateTime(code.created_at)}</td>
            <td>${code.expires_at ? formatDateTime(code.expires_at) : '永不过期'}</td>
            <td>${code.used_at ? formatDateTime(code.used_at) : '-'}</td>
            <td>
                <div class="btn-group btn-group-sm" role="group">
                    ${code.status === 'active' ? `
                        <button type="button" class="btn btn-outline-warning"
                                onclick="toggleCodeStatus('${code.id}', 'disabled')"
                                title="禁用">
                            <i class="fas fa-ban"></i>
                        </button>
                    ` : code.status === 'disabled' ? `
                        <button type="button" class="btn btn-outline-success"
                                onclick="toggleCodeStatus('${code.id}', 'active')"
                                title="启用">
                            <i class="fas fa-check"></i>
                        </button>
                    ` : ''}
                </div>
            </td>
        </tr>
    `).join('');
}

// 渲染分页（复用之前的函数）
function renderPagination(total, page, size) {
    const totalPages = Math.ceil(total / size);
    const pagination = document.getElementById('pagination');

    let html = '';

    // 上一页
    html += `
        <li class="page-item ${page <= 1 ? 'disabled' : ''}">
            <a class="page-link" href="#" onclick="${page > 1 ? `loadCodes(${page - 1})` : 'return false'}">
                上一页
            </a>
        </li>
    `;

    // 页码
    const startPage = Math.max(1, page - 2);
    const endPage = Math.min(totalPages, page + 2);

    for (let i = startPage; i <= endPage; i++) {
        html += `
            <li class="page-item ${i === page ? 'active' : ''}">
                <a class="page-link" href="#" onclick="loadCodes(${i})">${i}</a>
            </li>
        `;
    }

    // 下一页
    html += `
        <li class="page-item ${page >= totalPages ? 'disabled' : ''}">
            <a class="page-link" href="#" onclick="${page < totalPages ? `loadCodes(${page + 1})` : 'return false'}">
                下一页
            </a>
        </li>
    `;

    pagination.innerHTML = html;
}

// 搜索兑换码
function searchCodes() {
    loadCodes(1);
}

// 生成兑换码表单提交
document.getElementById('generateCodesForm').addEventListener('submit', function(e) {
    e.preventDefault();

    const formData = {
        credits: parseInt(document.getElementById('generateCredits').value),
        count: parseInt(document.getElementById('generateQuantity').value),
        batch_name: document.getElementById('generateBatch').value || null,
        expires_days: parseInt(document.getElementById('generateExpiryDays').value) || 365
    };

    // 隐藏生成表单，显示进度框
    bootstrap.Modal.getInstance(document.getElementById('generateCodesModal')).hide();
    const progressModal = new bootstrap.Modal(document.getElementById('generateProgressModal'));
    progressModal.show();

    // 重置进度
    document.getElementById('generateProgress').style.width = '0%';
    document.getElementById('generateStatus').textContent = '开始生成兑换码...';

    fetch('/api/v1/admin/redeem-codes/generate', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        credentials: 'include',
        body: JSON.stringify(formData)
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // 模拟进度更新
            updateProgress(100);
            document.getElementById('generateStatus').textContent =
                `成功生成 ${data.generated_count} 个兑换码！`;

            setTimeout(() => {
                progressModal.hide();
                showSuccess(`成功生成 ${data.generated_count} 个兑换码`);
                loadCodes(1);
                loadCodeStats();
                loadBatches();
            }, 2000);
        } else {
            progressModal.hide();
            showError('生成兑换码失败: ' + data.message);
        }
    })
    .catch(error => {
        progressModal.hide();
        console.error('Error:', error);
        showError('网络错误，请稍后重试');
    });
});

// 更新进度条
function updateProgress(percent) {
    document.getElementById('generateProgress').style.width = percent + '%';
}

// 切换兑换码状态
function toggleCodeStatus(codeId, newStatus) {
    fetch(`/api/v1/admin/redeem-codes/${codeId}`, {
        method: 'PUT',
        headers: {
            'Content-Type': 'application/json',
        },
        credentials: 'include',
        body: JSON.stringify({
            status: newStatus
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showSuccess('状态更新成功');
            loadCodes(currentPage);
            loadCodeStats();
        } else {
            showError('状态更新失败: ' + (data.detail || data.message || '未知错误'));
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showError('网络错误，请稍后重试');
    });
}

// 执行批量操作
function executeBatchOperation() {
    const operationType = document.getElementById('batchOperationType').value;
    const targetBatch = document.getElementById('batchTargetBatch').value;
    const extendDays = document.getElementById('extendDays').value;

    if (!targetBatch) {
        showError('请选择目标批次');
        return;
    }

    const requestData = {
        operation: operationType,
        batch_id: targetBatch
    };

    if (operationType === 'extend_expiry') {
        if (!extendDays || extendDays <= 0) {
            showError('请输入有效的延长天数');
            return;
        }
        requestData.extend_days = parseInt(extendDays);
    }

    fetch('/api/v1/admin/redeem-codes/batch-operation', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        credentials: 'include',
        body: JSON.stringify(requestData)
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showSuccess(`批量操作成功，影响 ${data.affected_count} 个兑换码`);
            bootstrap.Modal.getInstance(document.getElementById('batchOperationModal')).hide();
            loadCodes(currentPage);
            loadCodeStats();
        } else {
            showError('批量操作失败: ' + data.message);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showError('网络错误，请稍后重试');
    });
}

// 导出兑换码
function exportCodes() {
    const searchParams = new URLSearchParams();
    const code = document.getElementById('codeFilter').value;
    const status = document.getElementById('statusFilter').value;
    const batch = document.getElementById('batchFilter').value;
    const dateRange = document.getElementById('dateRangeFilter').value;

    if (code) searchParams.append('code', code);
    if (status) searchParams.append('status', status);
    if (batch) searchParams.append('batch_id', batch);
    if (dateRange) searchParams.append('date_range', dateRange);

    window.open(`/api/v1/admin/redeem-codes/export/csv?${searchParams}`, '_blank');
}

// 工具函数
function formatDateTime(dateString) {
    return new Date(dateString).toLocaleString('zh-CN');
}

function copyToClipboard(text) {
    navigator.clipboard.writeText(text).then(() => {
        showSuccess('已复制到剪贴板');
    });
}

function getStatusName(status) {
    const names = {
        'active': '可用',
        'used': '已使用',
        'expired': '已过期',
        'disabled': '已禁用'
    };
    return names[status] || status;
}

function getStatusBadgeClass(status) {
    const classes = {
        'active': 'bg-success',
        'used': 'bg-warning',
        'expired': 'bg-danger',
        'disabled': 'bg-secondary'
    };
    return classes[status] || 'bg-secondary';
}

function showSuccess(message) {
    // TODO: 实现成功提示
    alert('成功: ' + message);
}

function showError(message) {
    // TODO: 实现错误提示
    alert('错误: ' + message);
}
</script>

<style>
.cursor-pointer {
    cursor: pointer;
}
</style>
{% endblock %}