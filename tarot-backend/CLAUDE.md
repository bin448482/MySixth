# å¡”ç½—ç‰Œåº”ç”¨åç«¯å¼€å‘æŒ‡å— (CLAUDE.md)

## ğŸ“– é¡¹ç›®ç®€ä»‹

**å¡”ç½—ç‰Œåº”ç”¨åç«¯æœåŠ¡** æ˜¯ä¸€ä¸ªåŸºäº FastAPI çš„å¡”ç½—ç‰Œåº”ç”¨åç«¯ï¼Œæ”¯æŒåŒ¿åç”¨æˆ·ã€ç‰Œé˜µè§£è¯»ã€LLMé›†æˆå’Œæ”¯ä»˜åŠŸèƒ½ã€‚é‡‡ç”¨å•ä½“æ¶æ„å¿«é€Ÿä¸Šçº¿ï¼Œæ”¯æŒåç»­æ‰©å±•ã€‚

## ğŸ¯ æ ¸å¿ƒç›®æ ‡

- æ”¯æŒåŒ¿åç”¨æˆ·ç³»ç»Ÿï¼Œé™ä½ä½¿ç”¨é—¨æ§›
- æä¾›é™æ€åŸºç¡€è§£è¯» + ä»˜è´¹LLMåŠ¨æ€è§£è¯»
- å®Œæ•´çš„ç®¡ç†Portal + æ”¯ä»˜ç³»ç»Ÿé›†æˆ
- æ”¯æŒå…‘æ¢ç å’ŒGoogle Playå¤šå¹³å°æ”¯ä»˜
- å•ä½“æ¶æ„å¿«é€Ÿä¸Šçº¿ï¼Œæ”¯æŒåç»­æ‰©å±•

## ğŸ”§ æŠ€æœ¯æ ˆ

### åç«¯æ¡†æ¶
- **FastAPI 0.104+**: ç°ä»£Python Webæ¡†æ¶ï¼Œè‡ªåŠ¨APIæ–‡æ¡£
- **SQLAlchemy 2.0+**: ORMæ¡†æ¶ï¼Œæ”¯æŒå¼‚æ­¥æ“ä½œ
- **Alembic**: æ•°æ®åº“è¿ç§»å·¥å…·
- **Pydantic 2.0+**: æ•°æ®éªŒè¯å’Œåºåˆ—åŒ–

### å¤–éƒ¨æœåŠ¡é›†æˆ
- **LLMæœåŠ¡**: æ™ºè°±AI + OpenAI API
- **æ”¯ä»˜ç³»ç»Ÿ**: Google Play + å…‘æ¢ç ç³»ç»Ÿ
- **æ¨¡æ¿å¼•æ“**: Jinja2 (ç®¡ç†Portal)
- **è®¤è¯**: JWT (åŒ¿åç”¨æˆ· + ç®¡ç†å‘˜)

## ğŸ”— APIæ¥å£è®¾è®¡

### æ ¸å¿ƒAPI

| æ–¹æ³•   | è·¯å¾„                   | è¯´æ˜                    | çŠ¶æ€ |
| ---- | -------------------- | --------------------- | --- |
| POST | `/auth/anon`         | ç”ŸæˆåŒ¿åç”¨æˆ·ID              | âœ… å·²å®ç° |
| POST | `/readings/analyze`  | ç¬¬ä¸€æ­¥ï¼šåˆ†æç”¨æˆ·æè¿°ï¼Œè¿”å›æ¨èç»´åº¦     | âœ… å·²å®ç° |
| POST | `/readings/generate` | ç¬¬äºŒæ­¥ï¼šåŸºäºé€‰å®šç»´åº¦ç”Ÿæˆå¤šç»´åº¦è§£è¯»    | âœ… å·²å®ç° |
| GET  | `/api/v1/me/balance` | æŸ¥è¯¢ç”¨æˆ·ä½™é¢                | ğŸ”„ å¾…å®ç° |
| POST | `/api/v1/redeem`     | å…‘æ¢ç éªŒè¯å…‘æ¢               | ğŸ”„ å¾…å®ç° |

### è§£è¯»APIæµç¨‹ï¼ˆåˆ†ä¸¤æ­¥ï¼‰
1. **åˆ†æé˜¶æ®µ** (`/readings/analyze`)ï¼šç”¨æˆ·è¾“å…¥æè¿° â†’ LLMåˆ†æ â†’ è¿”å›æ¨èç»´åº¦
2. **ç”Ÿæˆé˜¶æ®µ** (`/readings/generate`)ï¼šé€‰æ‹©ç»´åº¦å’Œå¡ç‰Œ â†’ LLMç”Ÿæˆ â†’ è¿”å›è¯¦ç»†è§£è¯»

## ğŸ“Š æ•°æ®åº“é…ç½®

### æ•°æ®åº“æ–‡ä»¶ç®¡ç†
- **åå°æ•°æ®åº“**: `./backend_tarot.db` (ç‹¬ç«‹æ•°æ®åº“æ–‡ä»¶)
- **æºæ•°æ®åº“**: `../tarot-ai-generator/data/tarot_config.db`
- **è¿ç§»ç­–ç•¥**: ä»æºæ•°æ®åº“å¤åˆ¶æ ¸å¿ƒè¡¨

### æ ¸å¿ƒè¡¨ç»“æ„
1. **card** - å¡ç‰ŒåŸºç¡€ä¿¡æ¯ï¼ˆ78å¼ å¡”ç½—ç‰Œï¼‰
2. **dimension** - è§£è¯»ç»´åº¦å®šä¹‰
3. **card_interpretation** - ç‰Œæ„ä¸»è¡¨ï¼ˆ156æ¡æ­£é€†ä½è§£è¯»ï¼‰
4. **spread** - ç‰Œé˜µå®šä¹‰ï¼ˆä¸‰ç‰Œé˜µã€å‡¯å°”ç‰¹åå­—ï¼‰
5. **users** - åŒ¿åç”¨æˆ·ç®¡ç†
6. **purchases** - è®¢å•è®°å½•
7. **redeem_codes** - å…‘æ¢ç ç®¡ç†

## ğŸš¨ å¸¸è§é—®é¢˜è§£å†³æ–¹æ¡ˆ

### é‚®ä»¶éªŒè¯é“¾æ¥404é”™è¯¯é—®é¢˜

**é—®é¢˜ç°è±¡**ï¼š
- é‚®ä»¶ä¸­çš„éªŒè¯é“¾æ¥æ— æ³•è®¿é—®ï¼Œè¿”å› `{"detail":"Not Found"}` 404é”™è¯¯

**æ ¹æœ¬åŸå› **ï¼š
- é‚®ä»¶æœåŠ¡ä¸­ç”Ÿæˆçš„URLè·¯å¾„ä¸å®é™…APIè·¯ç”±ä¸åŒ¹é…
- FastAPIè·¯ç”±æ³¨å†Œæ—¶çš„å‰ç¼€é…ç½®é—®é¢˜

**é—®é¢˜å®šä½æ­¥éª¤**ï¼š
1. **æ£€æŸ¥APIæ–‡æ¡£**ï¼šè®¿é—® `http://localhost:8001/docs` æˆ– `http://localhost:8001/openapi.json`
2. **ç¡®è®¤å®é™…è·¯ç”±**ï¼šåœ¨openapi.jsonä¸­æœç´¢ `email/verify` æ‰¾åˆ°çœŸå®è·¯å¾„
3. **å¯¹æ¯”é‚®ä»¶URL**ï¼šæ£€æŸ¥é‚®ä»¶ä¸­ç”Ÿæˆçš„URLæ˜¯å¦ä¸å®é™…è·¯ç”±åŒ¹é…

**è§£å†³æ–¹æ¡ˆ**ï¼š

1. **è·¯ç”±é…ç½®** (`app/main.py`):
```python
# ç¡®ä¿è®¤è¯è·¯ç”±æ­£ç¡®æ³¨å†Œ
app.include_router(auth.router, prefix="/api/v1")  # å®é™…è·¯å¾„: /api/v1/auth/email/verify
```

2. **é‚®ä»¶URLç”Ÿæˆ** (`app/services/email_service.py`):
```python
# ä¿®æ­£é‚®ä»¶éªŒè¯URLç”Ÿæˆ
verification_url = f"{settings.APP_BASE_URL}/api/v1/auth/email/verify?token={verification_token}"
reset_url = f"{settings.APP_BASE_URL}/api/v1/auth/email/reset-password?token={reset_token}"
```

3. **ç¯å¢ƒé…ç½®** (`.env`):
```env
# ç¡®ä¿åŸºç¡€URLç«¯å£æ­£ç¡®
APP_BASE_URL=http://localhost:8001
```

**éªŒè¯æ–¹æ³•**ï¼š
```bash
# æµ‹è¯•è·¯ç”±æ˜¯å¦å¯è®¿é—®
curl -s "http://localhost:8001/api/v1/auth/email/verify?token=test-token"

# ä¸åº”è¯¥è¿”å›404ï¼Œè€Œåº”è¯¥è¿”å›å…·ä½“çš„ä¸šåŠ¡é”™è¯¯ï¼ˆå¦‚tokenæ— æ•ˆç­‰ï¼‰
```

**æ³¨æ„äº‹é¡¹**ï¼š
- ä¿®æ”¹è·¯ç”±é…ç½®åéœ€è¦é‡å¯æœåŠ¡å™¨
- uvicornçš„--reloadæ¨¡å¼ä¼šè‡ªåŠ¨æ£€æµ‹æ–‡ä»¶å˜åŒ–å¹¶é‡å¯
- ç¡®ä¿æ•°æ®åº“ä¸­email_verificationsè¡¨çš„user_idå­—æ®µå…³è”æ­£ç¡®

### é‚®ä»¶éªŒè¯é€»è¾‘é”™è¯¯é—®é¢˜

**é—®é¢˜ç°è±¡**ï¼š
- è·¯ç”±å¯ä»¥è®¿é—®ï¼Œä½†è¿”å›"ç”¨æˆ·ä¸å­˜åœ¨"é”™è¯¯

**æ ¹æœ¬åŸå› **ï¼š
- email_verifications.user_id å­˜å‚¨çš„æ˜¯æ•°æ®åº“å†…éƒ¨ID
- æŸ¥è¯¢usersè¡¨æ—¶é”™è¯¯ä½¿ç”¨äº†installation_idå­—æ®µ

**è§£å†³æ–¹æ¡ˆ**ï¼š
```python
# app/api/auth.py - verify_emailæ–¹æ³•ä¸­
# é”™è¯¯å†™æ³•ï¼š
user = db.query(User).filter(User.installation_id == verification.user_id).first()

# æ­£ç¡®å†™æ³•ï¼š
user = db.query(User).filter(User.id == verification.user_id).first()
```

### ç®¡ç†å‘˜APIè·¯ç”±å†²çªé—®é¢˜

**é—®é¢˜ç°è±¡**ï¼š
- è®¿é—®ç®¡ç†å‘˜é¡µé¢ `/admin/redeem-codes` æ—¶è‡ªåŠ¨é‡å®šå‘åˆ°ç™»å½•é¡µé¢
- APIè¯·æ±‚è¿”å› 403 Forbidden é”™è¯¯ï¼š`{"error":"Not authenticated","status_code":403}`
- æ—¥å¿—æ˜¾ç¤ºï¼š`"GET /api/v1/admin/redeem-codes?page=1&size=20 HTTP/1.1" 403 Forbidden`

**æ ¹æœ¬åŸå› **ï¼š
- åœ¨ `payments.py` å’Œ `admin.py` ä¸­å­˜åœ¨é‡å¤çš„è·¯ç”±å®šä¹‰
- `payments.py` ä¸­çš„ `@router.get("/admin/redeem-codes")` ä½¿ç”¨Bearer tokenè®¤è¯
- `admin.py` ä¸­çš„ `@redeem_router.get("")` (å®Œæ•´è·¯å¾„: `/api/v1/admin/redeem-codes`) ä½¿ç”¨Cookieè®¤è¯
- ç”±äºè·¯ç”±æ³¨å†Œé¡ºåºé—®é¢˜ï¼Œ`payments.router` å…ˆæ³¨å†Œï¼Œæ‹¦æˆªäº†æ‰€æœ‰è¯·æ±‚

**é—®é¢˜å®šä½æ­¥éª¤**ï¼š
1. **æ£€æŸ¥è·¯ç”±æ³¨å†Œé¡ºåº**ï¼šåœ¨ `app/main.py` ä¸­æŸ¥çœ‹è·¯ç”±æ³¨å†Œé¡ºåº
2. **æŸ¥æ‰¾é‡å¤è·¯ç”±**ï¼šä½¿ç”¨ `grep -r "/admin/redeem-codes" app/api/` æŸ¥æ‰¾é‡å¤è·¯ç”±
3. **ç¡®è®¤è®¤è¯æ–¹å¼å·®å¼‚**ï¼šæ¯”è¾ƒä¸¤ä¸ªè·¯ç”±çš„è®¤è¯ä¾èµ–é¡¹

**è§£å†³æ–¹æ¡ˆ**ï¼š
åˆ é™¤ `payments.py` ä¸­çš„é‡å¤è·¯ç”±ï¼Œä¿ç•™ `admin.py` ä¸­ä½¿ç”¨Cookieè®¤è¯çš„ä¸“ç”¨ç®¡ç†è·¯ç”±ï¼š

```python
# åˆ é™¤ app/api/payments.py ä¸­çš„é‡å¤è·¯ç”±ï¼š
@router.get("/admin/redeem-codes", response_model=RedeemCodeListResponse)
async def list_redeem_codes(...):
    # è¿™ä¸ªè·¯ç”±ä½¿ç”¨ Depends(require_admin) - Bearer tokenè®¤è¯
    pass

# ä¿ç•™ app/api/admin.py ä¸­çš„æ­£ç¡®è·¯ç”±ï¼š
@redeem_router.get("", response_model=RedeemCodeListResponse)
async def get_redeem_codes(
    current_admin: str = Depends(get_current_admin_from_cookie),  # Cookieè®¤è¯
    ...
):
    pass
```

**éªŒè¯æ–¹æ³•**ï¼š
```bash
# 1. è·å–ç®¡ç†å‘˜ç™»å½•token
curl -X POST "http://localhost:8001/admin/login" \
  -H "Content-Type: application/x-www-form-urlencoded" \
  -d "username=admin&password=admin123"

# 2. æµ‹è¯•APIè®¿é—®
curl "http://localhost:8001/api/v1/admin/redeem-codes?page=1&size=20" \
  -H "Cookie: admin_token=YOUR_TOKEN_HERE"
```

**é¢„é˜²æªæ–½**ï¼š
1. **è·¯ç”±å‘½åè§„èŒƒ**ï¼šç®¡ç†å‘˜ä¸“ç”¨APIä½¿ç”¨ `/api/v1/admin/` å‰ç¼€
2. **è®¤è¯æ–¹å¼ç»Ÿä¸€**ï¼šåŒä¸€åŠŸèƒ½æ¨¡å—ä½¿ç”¨ç»Ÿä¸€çš„è®¤è¯æ–¹å¼
3. **è·¯ç”±æ³¨å†Œæ£€æŸ¥**ï¼šå®šæœŸæ£€æŸ¥è·¯ç”±å†²çªï¼Œç¡®ä¿ä¸“ç”¨è·¯ç”±ä¼˜å…ˆæ³¨å†Œ

### payments.pyæ¨¡å—èŒè´£é‡æ„é—®é¢˜

**é—®é¢˜èƒŒæ™¯**ï¼š
- `payments.py` ä¸­åŒ…å«äº†å¤§é‡ç®¡ç†å‘˜ä¸“ç”¨åŠŸèƒ½ï¼ˆåˆ›å»ºã€ç»Ÿè®¡ã€ç¦ç”¨å…‘æ¢ç ç­‰ï¼‰
- è¿™äº›åŠŸèƒ½ä¸ `admin.py` ä¸­çš„ç®¡ç†åŠŸèƒ½é‡å¤
- ä¸åŒçš„è®¤è¯æ–¹å¼å¯¼è‡´æ¶æ„æ··ä¹±

**é‡æ„æ–¹æ¡ˆ**ï¼š
```python
# payments.py - åªä¿ç•™å‰ç«¯æ”¯ä»˜ç›¸å…³åŠŸèƒ½
router = APIRouter(prefix="/api/v1/payments", tags=["payments"])

@router.post("/redeem", response_model=RedeemCodeValidateResponse)
async def redeem_code(...):
    """å…‘æ¢ç éªŒè¯å…‘æ¢ï¼ˆå‰ç«¯æ ¸å¿ƒåŠŸèƒ½ï¼‰"""
    pass

# åˆ é™¤æ‰€æœ‰ç®¡ç†å‘˜è·¯ç”±ï¼š
# - POST /admin/redeem-codes/create
# - GET /admin/redeem-codes/batch/{batch_id}/stats
# - POST /admin/redeem-codes/disable
# - POST /admin/redeem-codes/cleanup-expired
```

**æ¨¡å—èŒè´£æ¸…æ™°åˆ’åˆ†**ï¼š
1. **payments.py**:
   - å‰ç¼€ï¼š`/api/v1/payments`
   - èŒè´£ï¼šå…‘æ¢ç å…‘æ¢ã€Google Playæ”¯ä»˜éªŒè¯
   - è®¤è¯ï¼šBearer Tokenï¼ˆé¢å‘å‰ç«¯åº”ç”¨ï¼‰

2. **admin.py**:
   - å‰ç¼€ï¼š`/api/v1/admin`
   - èŒè´£ï¼šå®Œæ•´çš„å…‘æ¢ç ç®¡ç†ã€ç”¨æˆ·ç®¡ç†
   - è®¤è¯ï¼šCookieï¼ˆé¢å‘ç®¡ç†åå°ï¼‰

**é‡æ„æ•ˆæœ**ï¼š
- æ¶ˆé™¤åŠŸèƒ½é‡å¤ï¼Œé¿å…è·¯ç”±å†²çª
- æ˜ç¡®æ¨¡å—è¾¹ç•Œï¼Œæé«˜ä»£ç å¯ç»´æŠ¤æ€§
- ç»Ÿä¸€è®¤è¯æ–¹å¼ï¼Œç®€åŒ–å‰åç«¯é›†æˆ

---

## ğŸš€ å¿«é€Ÿå¼€å§‹

### 1. ç¯å¢ƒé…ç½®
```bash
cp .env.example .env
# ç¼–è¾‘ .env æ–‡ä»¶é…ç½® LLM APIã€JWTå¯†é’¥ç­‰
```

### 2. å®‰è£…ä¾èµ–
```bash
pip install -r requirements.txt
```

### 3. è¿è¡Œå¼€å‘æœåŠ¡å™¨
```bash
uvicorn app.main:app --reload --host 0.0.0.0 --port 8000
```

## ğŸ“ è¯¦ç»†æ–‡æ¡£ç´¢å¼•

### æ ¸å¿ƒæ¨¡å—æ–‡æ¡£
- **æ•°æ®åº“æ¨¡å‹**: `app/models/CLAUDE.md` - æ•°æ®åº“è®¾è®¡å’ŒSQLAlchemyæ¨¡å‹
- **APIè·¯ç”±**: `app/api/CLAUDE.md` - æ¥å£è®¾è®¡å’Œå®ç°ç»†èŠ‚
- **ä¸šåŠ¡é€»è¾‘**: `app/services/CLAUDE.md` - æœåŠ¡å±‚å’ŒLLMé›†æˆ
- **ç®¡ç†Portal**: `app/admin/CLAUDE.md` - åå°ç®¡ç†ç³»ç»Ÿ
- **å·¥å…·å‡½æ•°**: `app/utils/CLAUDE.md` - è®¤è¯ã€å…‘æ¢ç ç­‰å·¥å…·

### å¼€å‘é˜¶æ®µè§„åˆ’
1. **é˜¶æ®µ1**: æ•°æ®åº“ä¸åŸºç¡€æ¶æ„ (1å¤©) ğŸ”¥
2. **é˜¶æ®µ2**: æ”¯ä»˜APIå¼€å‘ (2å¤©)
3. **é˜¶æ®µ3**: ç®¡ç†Portalå¼€å‘ (2å¤©)
4. **é˜¶æ®µ4**: é«˜çº§åŠŸèƒ½å’Œä¼˜åŒ– (1å¤©)
5. **é˜¶æ®µ5**: é›†æˆæµ‹è¯•å’Œéƒ¨ç½² (1å¤©)

## ğŸ”‘ å…³é”®æŠ€æœ¯å®ç°ç‚¹

### åŒ¿åç”¨æˆ·ç³»ç»Ÿ
- UUIDç”Ÿæˆå”¯ä¸€ç”¨æˆ·IDï¼ŒJWT tokenç®¡ç†ä¼šè¯
- æ— éœ€æ³¨å†Œï¼Œé™ä½ä½¿ç”¨é—¨æ§›

### æ”¯ä»˜ç³»ç»Ÿ
- å…‘æ¢ç ç³»ç»Ÿï¼š16ä½æ··åˆå­—ç¬¦ï¼Œæ‰¹æ¬¡ç®¡ç†
- Google Playé›†æˆï¼šè´­ä¹°éªŒè¯ï¼Œè®¢å•åŒæ­¥
- ç§¯åˆ†ç³»ç»Ÿï¼šåŸå­æ“ä½œï¼Œä¹è§‚é”é˜²å¹¶å‘

### è§£è¯»ç®—æ³•
- åŸºäºç”¨æˆ·æè¿°çš„LLMç»´åº¦æ¨è
- å‚è€ƒ `generate_single_interpretation` æ–¹æ³•
- æ”¯æŒä¸‰ç‰Œé˜µå’Œå‡¯å°”ç‰¹åå­—ä¸¤ç§ç‰Œé˜µ

## ğŸ›¡ï¸ å®‰å…¨è€ƒè™‘

- APIå®‰å…¨ï¼šHTTPSä¼ è¾“ã€è¾“å…¥éªŒè¯ã€SQLæ³¨å…¥é˜²æŠ¤
- æ”¯ä»˜å®‰å…¨ï¼šè´­ä¹°å‡­è¯éªŒè¯ã€åŸå­æ€§æ›´æ–°ã€å¹‚ç­‰æ€§æ§åˆ¶
- ç®¡ç†Portalå®‰å…¨ï¼šJWTè®¤è¯ã€CSRFé˜²æŠ¤ã€æ“ä½œå®¡è®¡
- å…‘æ¢ç å®‰å…¨ï¼šé˜²çˆ†ç ´ã€ä½¿ç”¨é™åˆ¶ã€æ‰¹æ¬¡ç®¡ç†

## ğŸ§ª æµ‹è¯•ç­–ç•¥

æµ‹è¯•è¦åˆ›å»ºåˆ° `tests/` ç›®å½•ä¸‹ï¼š
- **å•å…ƒæµ‹è¯•**: æ”¯ä»˜æœåŠ¡ã€å…‘æ¢ç ç”Ÿæˆã€ç§¯åˆ†æ‰£å‡
- **é›†æˆæµ‹è¯•**: Google Play APIã€æ•°æ®åº“äº‹åŠ¡ã€æ”¯ä»˜æµç¨‹
- **å®‰å…¨æµ‹è¯•**: SQLæ³¨å…¥ã€XSSã€CSRFé˜²æŠ¤éªŒè¯

## ğŸ“ˆ æ‰©å±•æ€§è€ƒè™‘

- å¾®æœåŠ¡æ‹†åˆ†é¢„ç•™ï¼šç”¨æˆ·æœåŠ¡ã€è§£è¯»æœåŠ¡ã€æ”¯ä»˜æœåŠ¡
- æ€§èƒ½æ‰©å±•ç‚¹ï¼šRedisç¼“å­˜ã€Celeryå¼‚æ­¥ä»»åŠ¡ã€æ•°æ®åº“è¯»å†™åˆ†ç¦»
- ç›‘æ§å‘Šè­¦ï¼šæ”¯ä»˜æˆåŠŸç‡ã€APIå“åº”æ—¶é—´ã€æ•°æ®åº“è¿æ¥

---

**å¼€å‘é¢„è®¡æ—¶é—´**: 7ä¸ªå·¥ä½œæ—¥
**éƒ¨ç½²è¦æ±‚**: Google Playå¼€å‘è€…è´¦æˆ·å’ŒæœåŠ¡è´¦æˆ·å¯†é’¥

*è¯¦ç»†å®ç°ç»†èŠ‚è¯·æŸ¥çœ‹å„å­ç›®å½•ä¸‹çš„ CLAUDE.md æ–‡æ¡£ã€‚*