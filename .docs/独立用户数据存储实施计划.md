# 塔罗牌用户数据独立存储实施计划

## 📊 现状分析
- **当前系统**: 所有数据存储在 `tarot_config.db` 中
- **问题**: 更新配置时会删除用户历史数据
- **需求**: 将用户占卜结果保存到独立数据库

## 🎯 实施策略

### 阶段1: 数据库架构设计
**新建数据库**: `tarot_user_data.db`
**保留表**: `user_history`（仅迁移此表）
**双数据库架构**:
- `tarot_config.db`: 只读配置数据（卡牌、牌阵、解读等）
- `tarot_user_data.db`: 读写用户数据（历史记录）

### 阶段2: 技术实现

#### 1. 创建用户数据库
```sql
-- tarot_user_data.db
CREATE TABLE user_history (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    user_id TEXT NOT NULL,
    timestamp DATETIME DEFAULT CURRENT_TIMESTAMP,
    spread_id INTEGER,
    card_ids TEXT NOT NULL, -- JSON格式
    interpretation_mode TEXT DEFAULT 'default',
    result TEXT NOT NULL, -- JSON格式
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    updated_at DATETIME DEFAULT CURRENT_TIMESTAMP
);

-- 索引优化
CREATE INDEX idx_user_history_user_id ON user_history(user_id);
CREATE INDEX idx_user_history_timestamp ON user_history(timestamp);
```

#### 2. 数据库连接管理
- 创建双数据库连接池
- 配置读写分离
- 实现连接池管理器

#### 3. 数据迁移方案
- 备份现有 `user_history` 数据
- 迁移到新的 `tarot_user_data.db`
- 验证数据完整性

### 阶段3: API层更新

#### 后端API修改
- 更新所有涉及 `user_history` 的API端点
- 实现双数据库查询逻辑
- 优化查询性能

#### 离线同步调整
- 配置数据：从 `tarot_config.db` 读取
- 用户数据：写入 `tarot_user_data.db`
- 确保同步机制正确区分两类数据

### 阶段4: 部署与验证
- 生产环境双数据库部署
- 数据迁移脚本
- 回滚方案准备
- 监控与日志

## 🛡️ 风险管控
- **数据安全**: 迁移前完整备份
- **回滚机制**: 保留原数据库48小时
- **性能监控**: 监控双数据库性能指标
- **兼容性**: 确保现有API接口不变

## 📈 预期效果
- ✅ 用户数据永久保存，不受配置更新影响
- ✅ 支持配置数据的无损更新
- ✅ 提升系统可维护性
- ✅ 为未来用户数据扩展奠定基础

## 🔧 具体实施步骤

### 步骤1: 环境准备
1. 创建新的数据库文件 `tarot_user_data.db`
2. 设计用户数据库表结构
3. 配置数据库连接参数

### 步骤2: 数据库连接管理
1. 创建数据库连接管理类
2. 实现双数据库连接池
3. 配置读写分离策略

### 步骤3: 数据迁移
1. 备份现有 `user_history` 数据
2. 编写数据迁移脚本
3. 验证迁移后数据完整性

### 步骤4: API更新
1. 修改所有涉及用户历史的API
2. 更新数据库查询逻辑
3. 测试API功能正常

### 步骤5: 部署上线
1. 生产环境部署新架构
2. 执行数据迁移
3. 验证系统功能
4. 监控系统性能

## 📋 检查清单
- [ ] 创建 `tarot_user_data.db` 数据库
- [ ] 设计并实现用户表结构
- [ ] 实现双数据库连接管理
- [ ] 备份现有用户数据
- [ ] 编写数据迁移脚本
- [ ] 更新所有相关API接口
- [ ] 测试离线同步机制
- [ ] 验证数据读写功能
- [ ] 准备回滚方案
- [ ] 生产环境部署
- [ ] 监控运行状态

## 🚨 注意事项
1. **数据备份**: 迁移前必须完整备份所有用户数据
2. **灰度发布**: 建议先在测试环境完整验证
3. **监控告警**: 部署后密切关注系统性能和错误日志
4. **用户通知**: 如有必要，提前通知用户可能的短暂服务中断
5. **文档更新**: 同步更新相关技术文档和运维手册