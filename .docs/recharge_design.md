# 充值设计文档（精简版）

本设计将“积分”定位为 LLM 调用费用余额。国内按 1 积分 = 1 元人民币；海外使用各商店本币计价，服务端换算为积分。用户仅通过充值获得积分。

一、地域与渠道策略
- 国内（iOS/Android/Web）
  - 支付方式：微信支付、支付宝
  - 说明：采用服务端下单 + 平台异步回调发放积分
- 海外（iOS/Android）
  - 支付方式：原生内购
    - iOS：Apple In‑App Purchase (IAP)
    - Android：Google Play Billing
  - 说明：仅使用原生内购，不接入第三方（如 Stripe）

二、套餐与定价
- 国内（RMB）：10 / 30 / 50 / 100 / 300 / 500（元）→ 同额积分（10→10分）
- 海外（本币）：$1.99 / $4.99 / $9.99 / $19.99 / $49.99 / $99.99
  - 积分换算：由服务端按汇率换算为积分，四舍五入到“分”级别
  - 展示规则：客户端展示“价格 + 对应积分”，实际发放以服务端核算为准

三、统一订单与回调流程（抽象）
1) 用户选择套餐 → 选择支付方式/触发内购
2) 发起支付
   - 国内：后端创建订单并返回调起参数，前端调起微信/支付宝
   - 海外：前端发起 IAP/GPB 购买，获取收据/Token
3) 验证与回调
   - 国内：支付平台异步通知后端（验签 + 金额校验）
   - 海外：后端调用 Apple/Google 验证接口校验收据/Token
4) 发放积分
   - 后端基于验证成功结果执行原子发放（记录幂等）
5) 前端刷新余额并展示结果

四、接口与后端逻辑（示例）
- 创建订单（国内）：POST /api/recharge/create
  - 入参：套餐ID、渠道（wechat/alipay）、客户端信息
  - 出参：调起支付参数（prepay_id / orderStr）
- 支付回调（国内）：
  - 微信：/api/recharge/wechat/notify（验签、订单金额、状态）
  - 支付宝：/api/recharge/alipay/notify（验签、订单金额、状态）
- 内购验证（海外）：
  - iOS：POST /api/recharge/ios/verify（收据）
  - Android：POST /api/recharge/android/verify（purchaseToken）
  - 后端调用官方验证接口 → 校验商品ID、价格、交易ID → 发放积分
- 幂等策略：
  - 唯一键：第三方交易号（transaction_id / purchaseToken / Apple Transaction ID）
  - 幂等表：记录交易号→内部订单→发放状态，重复回调不重复发

五、订单与状态机
- 订单状态：created → paying → paid → credited → failed/canceled
- 发放积分仅在 paid→credited 转移时进行，使用数据库事务确保一致性
- 失败与补偿：支持对账与手工补发（仅在验证通过场景）

六、UI/UX 纲要
- 入口：设置/钱包 → 充值
- 布局：
  - 顶部：当前积分余额
  - 中部：套餐卡片（价格+积分），根据地域展示对应渠道或内购按钮
  - 底部：支付方式区（国内显示微信/支付宝；海外直接展示“购买”按钮）
- 成功页：显示充值金额、到账积分、新余额；提供“返回/继续使用AI占卜”
- 历史页：展示充值记录（时间、渠道、金额、积分、状态）

七、合规与风控（精简）
- 国内：严格按支付平台接口规范，验签+金额白名单校验，防订单篡改
- 海外：遵守 Apple/Google 商店政策，仅用内购购买数字内容
- 风控：限额、异常频次拦截、回调签名校验、来源IP白名单（可选）
- 日志与审计：记录订单全链路日志，方便对账

八、MVP 范围
- 国内：优先接入微信或支付宝任一；套餐先上 10/30/100 元
- 海外：iOS 用 IAP、Android 用 Google Billing；不接第三方支付
- 汇率：首版可服务端日更或固定档位，前后端显示与发放对齐

九、验收标准
- 正常支付路径积分到账≤5秒；失败不发放
- 幂等性：重复通知不重复发放
- 记录完整：充值记录可查询；金额/积分一致
- UI：价格、积分、渠道展示清晰；错误提示明确

十、后续扩展（可选）
- 国内补充云闪付
- 海外分区定价/本地化价格展示
- 发票/电子凭证与对账导出